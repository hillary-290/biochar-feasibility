<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Configuración del Proyecto (Herramienta 1)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
body { font-family: 'Inter', sans-serif; background-color: #f4f4f5; }
.input-section { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6; }
.section-title { @apply text-xl font-bold text-green-700 mb-4 pb-2 border-b border-gray-200; }
.label-text { @apply block text-sm font-medium text-gray-700 mb-1; }
.input-field { @apply mt-1 block w-full rounded-md border-gray-400 shadow-sm p-3 bg-white focus:border-green-500 focus:ring-green-500 transition duration-150; }
.input-field[readonly] { @apply bg-gray-100 text-gray-500 cursor-not-allowed; }

/* Accordion */
#feedstockCalculatorSection { max-height:0; opacity:0; overflow:hidden; transition:all 0.35s ease-in-out; @apply bg-green-50 p-0 mt-0 rounded-lg border border-green-200; }
#feedstockCalculatorSection.open { max-height:1000px; opacity:1; overflow:visible; padding:1.5rem; margin-top:1rem; }

/* Tooltip */
.tooltip-container { position: relative; display: inline-flex; align-items: center; cursor: help; vertical-align: middle; }
.tooltip-icon { width:16px; height:16px; background-color:#9ca3af; color:white; font-size:10px; font-weight:bold; border-radius:50%; display:flex; align-items:center; justify-content:center; }
.tooltip-text { position:absolute; width:240px; background-color:#374151; color:white; font-size:0.75rem; padding:10px; border-radius:6px; bottom:150%; left:50%; transform:translateX(-50%); visibility:hidden; opacity:0; transition:opacity 0.2s; pointer-events:none; z-index:50; text-align:left; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
.tooltip-container:hover .tooltip-text { visibility:visible; opacity:1; }

.progress-bar-container { @apply w-full bg-gray-200 rounded-full h-2.5 mb-6; }
.progress-bar { @apply bg-green-600 h-2.5 rounded-full transition-all duration-500; }

.nav-grid { @apply grid grid-cols-2 md:grid-cols-3 gap-3 items-center; }
.nav-button { display:inline-block; padding:12px 20px; font-weight:700; border:none; border-radius:12px; font-size:0.875rem; cursor:pointer; transition:opacity 0.2s; text-decoration:none; text-align:center; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -2px rgba(0,0,0,0.1); }
.nav-button:hover { opacity:0.9; }
.nav-button-blue { background-color:#2563eb; color:white; }
.nav-button-green { background-color:#16a34a; color:white; }
.nav-button-indigo { background-color:#4f46e5; color:white; }
.nav-button-white { background-color:white; color:#2563eb; border:2px solid #dbeafe; }
.nav-button-white:hover { background-color:#f9fafb; }

/* --- Batch Summary Styles --- */
.batch-item { @apply flex justify-between items-center bg-white p-2.5 rounded-md border border-gray-300; }
.batch-text { @apply text-sm font-medium text-gray-700; }
.batch-remove { @apply text-red-500 hover:text-red-700 text-lg font-bold cursor-pointer leading-none; }
.final-total { @apply text-lg font-bold text-green-700 text-right mt-4 pt-4 border-t border-gray-300; }
.btn { @apply w-full text-center px-4 py-2 font-medium rounded-lg transition; }
.btn-green { @apply bg-green-600 text-white hover:bg-green-700; }
.btn-blue { @apply bg-blue-600 text-white hover:bg-blue-700; }
.btn-gray { @apply bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300; }
/* --- End --- */

.hidden { display:none; }

/* ---------- FOOTER STYLE ---------- */
.disclaimer {
    text-align: left;
    font-size: 0.75rem;
    color: #6b7280; /* gray-500 */
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
}
.disclaimer p {
    margin-bottom: 0.5rem;
    font-style: italic;
}
.disclaimer strong {
    font-weight: 600;
    color: #4b5563; /* gray-600 */
    font-style: normal;
}
</style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-2xl mx-auto">

<header class="text-center mb-6">
    <h1 class="text-2xl md:text-3xl font-extrabold text-green-700">Calculadora de Viabilidad de Biocarbón</h1>
    <h2 class="text-lg font-medium text-gray-700 mt-1">para Cadenas de Suministro de Café y Cacao en América Latina</h2>
    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mt-4">Climatebase Fellowship Cohort 8 - Proyecto Capstone</p>
    <p class="text-xs font-medium text-gray-500 mt-2">(Todos los valores en USD)</p>
    
    <div class="mt-4 mb-6">
        <a href="https://chatgpt.com/g/g-691ea2b1c2888191b85e54e203c53b2f-biochar-feasibility-guide" 
           target="_blank" 
           class="inline-block bg-blue-50 text-blue-700 hover:text-blue-900 border border-blue-200 rounded-full px-4 py-1 text-sm font-medium transition">
            ¿Preguntas? Haz clic aquí para consultar al Asistente IA ↗
        </a>
    </div>

    <p class="text-lg font-medium text-green-800">Herramienta 1: Información y Escala</p>
</header>

<div class="w-full mb-8">
    <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
        <span>Paso 1 de 7: Configuración</span>
        <span>(Siguiente: Producción)</span>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar" style="width: 14%"></div>
    </div>
</div>

<div class="input-section">
    <h2 class="section-title">Información del Proyecto</h2>
    <div class="space-y-4">
        <label class="block">
            <span class="label-text">ID del Proyecto (Nombre Único)</span>
            <input type="text" id="inputProjectId" placeholder="ej., coop-santa-ana-1" class="input-field" required>
        </label>

        <hr class="my-4 border-gray-200">

        <label class="block">
            <span class="label-text font-bold text-green-800">Volumen Anual de Café/Cacao (Toneladas - materia seca)</span>
            <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">1 tonelada = 1,000 kg</span></div>
            <input type="number" id="inputFeedstockTonnes" class="input-field border-2 border-green-500" min="0" required placeholder="0.00">
        </label>

        <p class="text-sm text-gray-500 text-center">- O -</p>

        <button id="toggleFeedstockCalc" class="w-full text-center px-4 py-2 bg-green-100 text-green-800 font-medium rounded-lg hover:bg-green-200 transition">
            Calcular Volumen desde Contenedores de Exportación
        </button>

        <div id="feedstockCalculatorSection">
            <div class="p-4 space-y-4">
                <h3 class="text-lg font-bold text-green-800">Calculadora de Contenedores</h3>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                    <label class="block">
                        <span class="label-text">Región / Tamaño de Saco</span>
                        <select id="modalRegionSelect" class="input-field">
                            <option value="60" data-bags="320">60 kg (Brasil, África, Asia)</option>
                            <option value="69" data-bags="275">69 kg (Centro y Sudamérica)</option>
                            <option value="70" data-bags="275">70 kg (Colombia)</option>
                        </select>
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="block">
                            <span class="label-text">Sacos por Contenedor</span>
                            <input type="number" id="modalBagsPerContainer" class="input-field" value="320" min="0" readonly>
                        </label>
                        <label class="block">
                            <span class="label-text"># Contenedores/Año</span>
                            <input type="number" id="modalNumContainers" class="input-field" min="0">
                        </label>
                    </div>
                    <label class="block">
                        <span class="label-text">Tipo de Residuo</span>
                        <select id="modalFeedstockType" class="input-field">
                            <option value="0.35">Lavado (Solo Pulpa Seca)</option>
                            <option value="0.21">Lavado (Solo Pergamino)</option>
                            <option value="0.56">Lavado (Pulpa y Pergamino)</option>
                            <option value="3.0">Café Natural (Cáscara completa)</option>
                            <option value="1.4">Vainas de Cacao</option>
                        </select>
                    </label>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="addBatchBtn" class="nav-button nav-button-blue">
                        Calcular y Agregar
                    </button>
                    <button id="clearForNextBtn" class="nav-button nav-button-white">
                        Agregar Otro Tipo
                    </button>
                </div>

                <div id="batchSummary" class="mt-4 space-y-2">
                    <h3 class="text-sm font-bold text-gray-500 uppercase">Tipos Calculados</h3>
                    <div id="batchList" class="space-y-1">
                        <p id="noBatches" class="text-sm text-gray-400 italic">No se han agregado lotes.</p>
                    </div>
                    <div class="final-total">
                        Total Calculado: <span id="totalCalculated">0.00</span> toneladas
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button id="closeModalBtn" class="nav-button nav-button-white" style="color: #4b5563; border-color: #d1d5db;">Cancelar</button>
                    <button id="useTotalBtn" class="nav-button nav-button-green">Usar este Total</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="block">
                <span class="label-text">Modelo del Proyecto</span>
                <select id="selectProjectType" class="input-field" required>
                    <option value="" disabled selected>-- Seleccionar Modelo --</option>
                    <option value="centralized">Centralizado (Un solo centro)</option>
                    <option value="decentralized">Descentralizado (Múltiples centros)</option>
                    <option value="mobile">Hornos Móviles</option>
                </select>
            </label>
            <label class="block" id="hubsContainer" style="display:none;">
                <span class="label-text" id="hubsLabel">Número de Ubicaciones</span>
                <input type="number" id="inputNumHubs" value="1" min="1" class="input-field">
            </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="block">
                <span class="label-text">País</span>
                <select id="selectCountry" class="input-field" required>
                    <option value="" disabled selected>Seleccionar País</option>
                    <option value="bolivia">Bolivia</option>
                    <option value="brazil">Brasil</option>
                    <option value="colombia">Colombia</option>
                    <option value="costa_rica">Costa Rica</option>
                    <option value="dominican_republic">República Dominicana</option>
                    <option value="ecuador">Ecuador</option>
                    <option value="el_salvador">El Salvador</option>
                    <option value="guatemala">Guatemala</option>
                    <option value="honduras">Honduras</option>
                    <option value="mexico">México</option>
                    <option value="nicaragua">Nicaragua</option>
                    <option value="panama">Panamá</option>
                    <option value="peru">Perú</option>
                    <option value="custom">Otro / Personalizado</option>
                </select>
            </label>
            <label class="block">
                <span class="label-text">Apoyo Comunitario</span>
                <select id="selectCommunityBuyIn" class="input-field">
                    <option value="" disabled selected>-- Seleccionar Estado --</option>
                    <option value="not_secured">No asegurado</option>
                    <option value="in_process">En proceso</option>
                    <option value="secured">Asegurado</option>
                </select>
            </label>
        </div>
    </div>
</div>

<div class="input-section">
    <h2 class="section-title">Modelo de Estacionalidad</h2>
    <div class="space-y-4">
        <label class="block">
            <span class="label-text font-bold text-gray-800">
                ¿Cómo es la disponibilidad de su materia prima?
            </span>
            <select id="selectSupplyModel" class="input-field border-2 border-blue-300" required>
                <option value="" disabled selected>-- Seleccionar --</option>
                <option value="year_round">[A] Disponible todo el año.</option>
                <option value="seasonal">[B] Disponible solo en temporada de cosecha.</option>
            </select>
        </label>
        <p id="supplyDesc" class="text-sm text-gray-600 italic pl-2 border-l-2 border-blue-300">
            Seleccione una opción para describir su situación.
        </p>

        <div id="seasonalStrategyContainer" class="space-y-3 hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <label class="block">
                <span class="label-text font-bold text-yellow-900">
                    Si es estacional, ¿cómo operará su instalación?
                </span>
                <select id="selectSeasonalityStrategy" class="input-field">
                    <option value="" disabled selected>-- Seleccionar estrategia --</option>
                    <option value="store">[1] Almacenar y procesar todo el año</option>
                    <option value="diversify">[2] Usar otras materias primas el resto del año</option>
                    <option value="shutdown">[3] Procesar solo en cosecha y cerrar después</option>
                </select>
            </label>
            <p id="strategyDesc" class="text-sm text-yellow-800 italic">Elija la opción que mejor describa su plan operativo.</p>
        </div>
    </div>
</div>

<div class="input-section bg-gray-50 border-l-4 border-gray-400 p-4">
    <h3 class="font-bold text-gray-700 mb-2 uppercase text-sm tracking-wider">Notas para Investigación Futura</h3>
    <textarea id="toolNotes" rows="3" class="input-field bg-white" placeholder="Escriba aquí..."></textarea>
</div>

<div class="mt-8 mb-12 flex flex-col space-y-4">
    <button id="saveProjectButton" class="nav-button nav-button-indigo w-full">Guardar Datos del Proyecto</button>
    <div id="unsavedWarning" class="text-red-600 font-medium text-center hidden">Tienes cambios sin guardar.</div>
    <div id="savedConfirmation" class="text-green-600 font-medium text-center hidden">Todos los cambios guardados.</div>

    <div id="navigationButtons" class="nav-grid">
        <button onclick="navigate('index_es.html')" class="nav-button nav-button-white md:col-span-1">← Menú Principal</button>
        <button onclick="navigate('tool2_es.html')" id="nextToolButton" class="nav-button nav-button-green md:col-span-2">Ir a Herramienta 2 →</button>
    </div>
</div>

<div class="flex justify-between items-center pt-4">
    <button onclick="resetForm()" class="text-sm text-red-500 hover:text-red-700 font-medium">Reiniciar Formulario</button>
    <div id="saveStatus" class="font-medium text-green-600" style="display:none;"></div>
</div>

<footer class="disclaimer">
    <p><strong>Sin Garantía:</strong> <em>Las proyecciones proporcionadas por esta calculadora se basan en las suposiciones y datos ingresados por el usuario. Son solo para fines ilustrativos y no constituyen una garantía de costos reales, ingresos o rentabilidad.</em></p>
    <p><strong>No es Asesoramiento Financiero:</strong> <em>La información proporcionada no pretende sustituir el asesoramiento profesional financiero, legal o agrícola. Los usuarios son los únicos responsables de las decisiones tomadas en base a los resultados de esta herramienta.</em></p>
    <p><strong>Verificar Todos los Datos:</strong> <em>Los usuarios deben verificar independientemente todos los costos locales, precios de mercado y requisitos regulatorios antes de realizar cualquier inversión.</em></p>
</footer>

</div>

<template id="batchItemTemplate">
    <div class="batch-item">
        <span class="batch-text"></span>
        <span class="batch-remove" title="Eliminar">×</span>
    </div>
</template>

<script src="engine.js"></script>
<script>
/* TOOL 1 LOGIC (SAME AS ENGLISH) */
let projectData = {};
let hasUnsavedChanges = false;
let calculatedBatches = []; 
let batchCounter = 1;       

const saveButton = document.getElementById("saveProjectButton");
const unsavedWarning = document.getElementById("unsavedWarning");
const savedConfirmation = document.getElementById("savedConfirmation");
const navigationButtons = document.getElementById("navigationButtons");

// Popup Calculator Elements
const toggleFeedstockCalcBtn = document.getElementById("toggleFeedstockCalc");
const feedstockCalculatorSection = document.getElementById("feedstockCalculatorSection");
const addBatchBtn = document.getElementById("addBatchBtn");
const clearForNextBtn = document.getElementById("clearForNextBtn");
const closeModalBtn = document.getElementById("closeModalBtn");
const useTotalBtn = document.getElementById("useTotalBtn");
const batchList = document.getElementById("batchList");
const noBatches = document.getElementById("noBatches");
const totalCalculatedEl = document.getElementById("totalCalculated");
const batchTemplate = document.getElementById("batchItemTemplate");
const mainFeedstockInput = document.getElementById("inputFeedstockTonnes");
const modalNumContainers = document.getElementById("modalNumContainers");

// Warn on unsaved changes
window.addEventListener("beforeunload", e => {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = "";
    }
});

function setUnsaved() {
    hasUnsavedChanges = true;
    if (saveButton) {
        saveButton.disabled = false;
        saveButton.classList.remove("hidden");
    }
    if (unsavedWarning) unsavedWarning.classList.remove("hidden");
    if (savedConfirmation) savedConfirmation.classList.add("hidden");
    if (navigationButtons) navigationButtons.classList.add("hidden");
}

// Track input changes
[
    "inputProjectId","inputFeedstockTonnes","selectProjectType","inputNumHubs",
    "selectCountry","selectCommunityBuyIn","toolNotes","selectSupplyModel",
    "selectSeasonalityStrategy"
].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const evt = (el.tagName === "SELECT" || el.type === "select-one") ? "change" : "input";
    el.addEventListener(evt, setUnsaved);
});

// Update seasonality UI
function updateSeasonalityUI() {
    const model = document.getElementById("selectSupplyModel")?.value;
    const supplyDesc = document.getElementById("supplyDesc");
    const seasonalBox = document.getElementById("seasonalStrategyContainer");
    const strategy = document.getElementById("selectSeasonalityStrategy")?.value;
    const strategyDesc = document.getElementById("strategyDesc");

    if (!model) {
        if (supplyDesc) supplyDesc.textContent = "Seleccione una opción para describir su situación.";
        if (seasonalBox) seasonalBox.classList.add("hidden");
        return;
    }

    if (model === "year_round") {
        if (supplyDesc) supplyDesc.textContent = "Mi materia prima está disponible los 12 meses del año.";
        if (seasonalBox) seasonalBox.classList.add("hidden");
    } else {
        if (supplyDesc) supplyDesc.textContent = "Mi materia prima se concentra en una temporada de cosecha.";
        if (seasonalBox) seasonalBox.classList.remove("hidden");
    }

    if (strategyDesc && strategy) {
        if (strategy === "store") {
            strategyDesc.textContent = "Compraré la mayoría durante la cosecha y almacenaré para procesar todo el año.";
        } else if (strategy === "diversify") {
            strategyDesc.textContent = "Procesaré café durante la cosecha y usaré otras biomasas el resto del año.";
        } else if (strategy === "shutdown") {
            strategyDesc.textContent = "Procesaré durante la cosecha y cerraré operaciones el resto del año.";
        }
    }
}

document.getElementById("selectSupplyModel")?.addEventListener("change", updateSeasonalityUI);
document.getElementById("selectSeasonalityStrategy")?.addEventListener("change", updateSeasonalityUI);

// Load existing data
document.addEventListener("DOMContentLoaded", () => {
    let stored = null;
    if (window.BiocharEngine && BiocharEngine.loadProjectData) {
        stored = BiocharEngine.loadProjectData();
    } else {
        const ls = localStorage.getItem("biocharProjectData");
        stored = ls ? JSON.parse(ls) : null;
    }

    projectData = stored && typeof stored === "object" ? stored : {};
    const d = projectData.tool1 || {};

    if (d.projectId) document.getElementById("inputProjectId").value = d.projectId;
    if (typeof d.feedstockTonnes !== "undefined") document.getElementById("inputFeedstockTonnes").value = d.feedstockTonnes;
    if (d.projectType) document.getElementById("selectProjectType").value = d.projectType;
    if (typeof d.numHubs !== "undefined") document.getElementById("inputNumHubs").value = d.numHubs;
    if (d.country) document.getElementById("selectCountry").value = d.country;
    if (d.communityBuyIn) document.getElementById("selectCommunityBuyIn").value = d.communityBuyIn;
    if (d.notes_T1) document.getElementById("toolNotes").value = d.notes_T1;
    if (d.supplyModel) document.getElementById("selectSupplyModel").value = d.supplyModel;
    if (d.seasonalityStrategy) document.getElementById("selectSeasonalityStrategy").value = d.seasonalityStrategy;

    if (d.projectId) {
        saveButton.classList.add("hidden");
        navigationButtons.classList.remove("hidden");
        unsavedWarning.classList.add("hidden");
    } else {
        navigationButtons.classList.add("hidden");
    }

    handleProjectTypeChange();
    updateSeasonalityUI();
    updateBagsPerContainer();
});

// Popup Calculator Logic
toggleFeedstockCalcBtn?.addEventListener("click", () => {
    if (!feedstockCalculatorSection) return;
    feedstockCalculatorSection.classList.toggle("open");
    calculatedBatches = [];
    batchCounter = 1;
    renderBatches();
});

closeModalBtn?.addEventListener("click", () => {
    if (!feedstockCalculatorSection) return;
    feedstockCalculatorSection.classList.remove("open");
});

function updateBagsPerContainer() {
    const regionSelect = document.getElementById("modalRegionSelect");
    const bagsInput = document.getElementById("modalBagsPerContainer");
    if (!regionSelect || !bagsInput) return;

    const selectedOption = regionSelect.options[regionSelect.selectedIndex];
    const bags = selectedOption.getAttribute("data-bags") || "275";
    bagsInput.value = bags;
}
document.getElementById("modalRegionSelect")?.addEventListener("change", updateBagsPerContainer);

addBatchBtn?.addEventListener("click", () => {
    const bags = parseFloat(document.getElementById("modalBagsPerContainer").value) || 0;
    const weight = parseFloat(document.getElementById("modalRegionSelect").value) || 0;
    const containers = parseFloat(modalNumContainers.value) || 0;
    const typeSelect = document.getElementById("modalFeedstockType");
    const ratio = parseFloat(typeSelect.value) || 0;
    const typeText = typeSelect.options[typeSelect.selectedIndex].text.split("(")[0].trim();

    if (containers === 0) {
        alert("Por favor ingrese un número de contenedores.");
        return;
    }

    const totalKg = bags * weight * containers;
    const feedstockTonnes = (totalKg * ratio) / 1000;

    const batch = {
        id: batchCounter,
        text: `Lote ${batchCounter} (${typeText}): ${feedstockTonnes.toFixed(2)} ton`,
        tonnes: feedstockTonnes
    };
    batchCounter++;
    calculatedBatches.push(batch);
    renderBatches();
});

clearForNextBtn?.addEventListener("click", () => {
    modalNumContainers.value = "";
    modalNumContainers.focus();
});

function renderBatches() {
    if (!batchList) return;
    batchList.innerHTML = "";

    if (calculatedBatches.length === 0) {
        if (noBatches) {
            const clone = noBatches.cloneNode(true);
            clone.id = "";
            batchList.appendChild(clone);
        }
    } else {
        calculatedBatches.forEach(batch => {
            const clone = batchTemplate.content.cloneNode(true);
            clone.querySelector(".batch-text").textContent = batch.text;
            const removeBtn = clone.querySelector(".batch-remove");
            removeBtn.dataset.id = batch.id;

            removeBtn.addEventListener("click", () => {
                calculatedBatches = calculatedBatches.filter(b => b.id !== batch.id);
                renderBatches();
            });

            batchList.appendChild(clone);
        });
    }
    updateTotal();
}

function updateTotal() {
    const total = calculatedBatches.reduce((sum, batch) => sum + batch.tonnes, 0);
    if (totalCalculatedEl) totalCalculatedEl.textContent = total.toFixed(2);
}

useTotalBtn?.addEventListener("click", () => {
    const total = calculatedBatches.reduce((sum, batch) => sum + batch.tonnes, 0);
    if (mainFeedstockInput) mainFeedstockInput.value = total.toFixed(2);
    if (feedstockCalculatorSection) feedstockCalculatorSection.classList.remove("open");
    setUnsaved();
});

// Save project
saveButton?.addEventListener("click", () => {
    const projectId = document.getElementById("inputProjectId").value.trim();
    if (!projectId) {
        alert("Por favor ingrese un ID de Proyecto.");
        return;
    }

    const projectType = document.getElementById("selectProjectType").value;
    const supplyModel = document.getElementById("selectSupplyModel").value;
    const country = document.getElementById("selectCountry").value;
    const feedstock = document.getElementById("inputFeedstockTonnes").value;

    if (!projectId || !projectType || !supplyModel || !country || !feedstock) {
        alert("Por favor complete todos los campos requeridos.");
        return;
    }

    const supplyModelEl = document.getElementById("selectSupplyModel");
    const strategyEl = document.getElementById("selectSeasonalityStrategy");

    if (!projectData || typeof projectData !== "object") {
        projectData = {};
    }
    projectData.tool1 = {
        projectId,
        feedstockTonnes: parseFloat(feedstock) || 0,
        projectType: projectType,
        numHubs: parseInt(document.getElementById("inputNumHubs").value) || 1,
        country: country,
        communityBuyIn: document.getElementById("selectCommunityBuyIn").value,
        supplyModel: supplyModelEl ? (supplyModelEl.value || "") : "",
        seasonalityStrategy: strategyEl ? (strategyEl.value || "") : "",
        notes_T1: document.getElementById("toolNotes").value,
        lastUpdated: new Date().toISOString()
    };

    if (window.BiocharEngine && BiocharEngine.saveProjectData) {
        BiocharEngine.saveProjectData({
            ...(projectData || {}),
            tool1: projectData.tool1
        });
    } else {
        const existing = JSON.parse(localStorage.getItem("biocharProjectData") || "{}");
        const merged = { ...existing, tool1: projectData.tool1 };
        localStorage.setItem("biocharProjectData", JSON.stringify(merged));
    }

    localStorage.setItem("currentProjectId", projectId);

    hasUnsavedChanges = false;
    if (unsavedWarning) unsavedWarning.classList.add("hidden");
    if (savedConfirmation) savedConfirmation.classList.remove("hidden");
    if (saveButton) saveButton.classList.add("hidden");
    if (navigationButtons) navigationButtons.classList.remove("hidden");

    setTimeout(() => {
        if (savedConfirmation) savedConfirmation.classList.add("hidden");
    }, 2500);
});

// Updated Hub Logic
function handleProjectTypeChange() {
    const type = document.getElementById("selectProjectType").value;
    const container = document.getElementById("hubsContainer");
    const label = document.getElementById("hubsLabel");
    const input = document.getElementById("inputNumHubs");

    if (!container || !label || !input) return;

    if (type === "centralized") {
        container.style.display = "none";
        input.value = 1;
        input.min = 1;
    } else if (type === "decentralized") {
        container.style.display = "block";
        label.textContent = "Número de Centros de Procesamiento";
        if (input.value < 2) input.value = 2;
        input.min = 2;
    } else if (type === "mobile") {
        container.style.display = "block";
        label.textContent = "Número de Hornos Móviles";
        input.value = 1;
        input.min = 1;
    }
}
document.getElementById("selectProjectType")?.addEventListener("change", handleProjectTypeChange);

// Smart Navigation
window.navigate = function(url) {
    if (hasUnsavedChanges) {
        alert("Tienes cambios sin guardar. Haz clic en 'Guardar' antes de continuar.");
    } else {
        window.location.href = url;
    }
};

// Global Reset Button Logic
window.resetForm = function() {
    if (!confirm("Esto borrará TODOS los datos del proyecto. ¿Estás seguro?")) return;

    projectData = {};

    if (window.BiocharEngine && BiocharEngine.clearProjectData) {
        BiocharEngine.clearProjectData();
    } else {
        localStorage.removeItem("biocharProjectData");
        localStorage.removeItem("currentProjectId");
    }

    location.reload();
};
</script>
</body>
</html>