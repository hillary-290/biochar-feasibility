<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Ejecutivo (Herramienta 6)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="engine.js"></script> 
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f4f5; }
        .dashboard-card { @apply bg-white p-6 rounded-2xl shadow-sm border border-gray-200; }
        .hero-metric { @apply flex flex-col justify-between h-full; }
        .hero-label { @apply text-sm font-medium text-gray-500 uppercase tracking-wider mb-2 flex items-center; }
        .hero-value { @apply text-4xl font-extrabold text-gray-900; }
        .hero-sub { @apply text-xs font-medium mt-2; }
        
        /* Risk Cards */
        .kpi-card { padding: 1rem; border-radius: 0.5rem; border-width: 2px; margin-bottom: 0.75rem; }
        .kpi-green { background-color: #f0fdf4; border-color: #bbf7d0; }
        .kpi-yellow { background-color: #fefce8; border-color: #fde047; }
        .kpi-red { background-color: #fef2f2; border-color: #fca5a5; }
        .kpi-blue { background-color: #eff6ff; border-color: #bfdbfe; } 
        
        .kpi-title { font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem; }
        .kpi-desc { font-size: 0.875rem; color: #374151; line-height: 1.25; }

        .kpi-green .kpi-title { color: #166534; }
        .kpi-yellow .kpi-title { color: #854d0e; }
        .kpi-red .kpi-title { color: #991b1b; }
        .kpi-blue .kpi-title { color: #1e40af; }

        /* NEW Cosmetic Style */
        .section-title { @apply text-xl font-bold pb-2 border-b mb-4; }
        .section-title-gray { @apply text-gray-800 border-gray-300; }
        .section-title-yellow { @apply text-yellow-900 border-yellow-300; }
        /* --- End New Style --- */

        .action-item { @apply p-3 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-gray-700 mb-2; }
        .action-source { @apply font-bold text-yellow-900 block mb-1; }

        /* --- ICONS --- */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; cursor: help; }
        .f-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #6b7280; color: white; border-radius: 50%; font-family: 'Georgia', serif; font-style: italic; font-weight: bold; font-size: 14px; line-height: 1; padding-bottom: 2px; margin-left: 6px; }
        .tooltip-text { position: absolute; width: 240px; background-color: #374151; color: white; font-size: 0.75rem; padding: 10px; border-radius: 6px; bottom: 150%; left: 50%; transform: translateX(-50%); visibility: hidden; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 50; font-weight: normal; text-align: left; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* --- PROGRESS BAR --- */
        .progress-bar-container { @apply w-full bg-gray-200 rounded-full h-2.5 mb-6; }
        .progress-bar { @apply bg-green-600 h-2.5 rounded-full transition-all duration-500; }
        
        /* --- FOOTER --- */
        .disclaimer {
            text-align: left;
            font-size: 0.75rem;
            color: #6b7280; /* gray-500 */
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        .disclaimer p {
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .disclaimer strong {
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            font-style: normal;
        }

        /* --- NAVIGATION BUTTONS --- */
        .nav-grid { @apply grid grid-cols-2 md:grid-cols-3 gap-3 items-center; }
        .nav-button { display: inline-block; padding: 12px 20px; font-weight: 700; border: none; border-radius: 12px; font-size: 0.875rem; cursor: pointer; transition: opacity 0.2s; text-decoration: none; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .nav-button:hover { opacity: 0.9; }
        .nav-button-blue { background-color: #2563eb; color: white; }
        .nav-button-green { background-color: #16a34a; color: white; }
        .nav-button-indigo { background-color: #4f46e5; color: white; }
        .nav-button-white { background-color: white; color: #2563eb; border: 2px solid #dbeafe; }
        .nav-button-white:hover { background-color: #f9fafb; }
        
        .hidden { display: none; }
        .print-only { display: none; } 

        /* --- PRINT STYLES --- */
        @media print {
            body > div > header, body > div > .w-full.mb-8, body > div > .nav-grid,
            body > div > .text-center, #loadingIndicator { display: none !important; }
            
            .disclaimer-container { display: block !important; }
            footer { display: block !important; position: static !important; margin-top: 20px; font-size: 10px !important; }
            
            .print-me { display: block !important; width: 100% !important; page-break-inside: avoid; }
            .print-only { display: block !important; page-break-before: always; } 
            
            body { 
                background-color: #ffffff; 
                padding: 0; 
                margin: 0; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                font-size: 11px; /* Scale down all font */
            }
            .max-w-5xl { max-width: 100%; }
            
            .grid.gap-4.mb-8 { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 10px !important; }
            .grid.lg\:grid-cols-3 { display: grid !important; grid-template-columns: 2fr 1fr !important; gap: 15px !important; }
            .lg\:col-span-1, .lg\:col-span-2 { grid-column: auto / span 1; width: 100% !important; }
            .lg\:col-span-2 { grid-column: auto / span 2; }
            
            .dashboard-card, .bg-blue-50, .bg-green-50, .bg-gray-50, .kpi-card { 
                border: 1px solid #ddd !important; 
                box-shadow: none !important; 
                margin-bottom: 10px; 
                padding: 10px !important; 
                background-color: #fff !important; 
            }
            .kpi-green { background-color: #f0fdf4 !important; border-color: #bbf7d0 !important; }
            .kpi-yellow { background-color: #fefce8 !important; border-color: #fde047 !important; }
            .kpi-red { background-color: #fef2f2 !important; border-color: #fca5a5 !important; }
            .kpi-blue { background-color: #eff6ff !important; border-color: #bfdbfe !important; }
            
            .hero-value { font-size: 20px !important; } 
            .hero-label { font-size: 11px !important; }
            .hero-sub { font-size: 10px !important; }
            .text-3xl { font-size: 20px !important; }
            .text-xl { font-size: 16px !important; }
            .text-sm { font-size: 11px !important; }
            .text-xs { font-size: 10px !important; }
            
            .f-icon, .tooltip-container { display: none !important; }
            
            #printSummary h2 { font-size: 18px; font-weight: bold; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #ccc; }
            #printSummary h3 { font-size: 14px; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
            #printSummary table { width: 100%; border-collapse: collapse; }
            #printSummary th, #printSummary td { border: 1px solid #eee; padding: 6px; text-align: left; font-size: 10px; }
            #printSummary th { background-color: #f9fafb; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-extrabold text-green-700">Calculadora de Viabilidad de Biochar</h1>
            <h2 class="text-lg font-medium text-gray-700 mt-1">para Cadenas de Suministro de Caf√© y Cacao en Am√©rica Latina</h2>
            <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mt-4">Climatebase Fellowship Cohort 8 - Proyecto Capstone</p>
            <p class="text-xs font-medium text-gray-500 mt-2">(Todos los valores en USD)</p>
            
            <div class="mt-4 mb-6">
                <a href="https://chatgpt.com/g/g-691ea2b1c2888191b85e54e203c53b2f-biochar-feasibility-guide" 
                   target="_blank" 
                   class="inline-block bg-blue-50 text-blue-700 hover:text-blue-900 border border-blue-200 rounded-full px-4 py-1 text-sm font-medium transition">
                    ¬øPreguntas? Haz clic aqu√≠ para consultar al Asistente IA de Biochar ‚Üó
                </a>
            </div>

            <p class="text-lg font-medium text-green-800">Herramienta 6: Panel Ejecutivo</p>
        </header>

        <div class="w-full mb-8">
            <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                <span>Paso 6 de 7: Panel</span>
                <span>(Siguiente: Escenarios)</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 85.7%"></div>
            </div>
        </div>

        <div id="loadingIndicator" class="flex items-center text-blue-600 font-medium animate-pulse mt-4 text-sm">
            <svg class="animate-spin -ml-1 mr-3 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Calculando resultados finales...
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 print-me">
            <div class="dashboard-card hero-metric">
                <span class="hero-label">Costo Inicial (CAPEX)</span>
                <span id="heroCapex" class="hero-value">$0</span>
                <span class="hero-sub text-gray-500">Efectivo D√≠a 1</span>
            </div>
            <div class="dashboard-card hero-metric">
                <span class="hero-label">Beneficio Neto Anual</span>
                <span id="heroProfit" class="hero-value">$0</span>
                <span class="hero-sub text-gray-500">Post Impuestos y OPEX</span>
            </div>
            <div class="dashboard-card hero-metric">
                <span class="hero-label">
                    Per√≠odo de Recuperaci√≥n
                    <div class="tooltip-container ml-1">
                        <span class="f-icon">f</span>
                        <span class="tooltip-text">**F√≥rmula:**<br>CAPEX Total / Beneficio Neto Anual<br><br>A√±os para recuperar la inversi√≥n inicial.</span>
                    </div>
                </span>
                <span id="heroPayback" class="hero-value">--</span>
                <span class="hero-sub text-gray-500">A√±os para punto de equilibrio</span>
            </div>
            <div class="dashboard-card hero-metric">
                <span class="hero-label">
                    <span id="npvYears">10-A√±os</span> VPL
                    <div class="tooltip-container ml-1">
                        <span class="f-icon">f</span>
                        <span class="tooltip-text">**Valor Presente Neto:**<br>Valor total de beneficios futuros en d√≥lares de hoy, menos inversi√≥n inicial.</span>
                    </div>
                </span>
                <span id="heroNpv" class="hero-value">$0</span>
                <span class="hero-sub text-gray-500">Valor Presente Neto</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <div class="lg:col-span-2 space-y-6 print-me">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="dashboard-card bg-blue-50 border-blue-100">
                        <h3 class="text-sm font-bold text-blue-900 uppercase tracking-wider mb-1">Producci√≥n F√≠sica</h3>
                        <div class="flex items-baseline">
                            <span id="valBiochar" class="text-3xl font-extrabold text-blue-700 mr-2">0</span>
                            <span class="text-blue-600 font-medium">ton / a√±o</span>
                        </div>
                        <p class="text-xs text-blue-400 mt-1">Biochar producido</p>
                    </div>
                    <div class="dashboard-card bg-green-50 border-green-100">
                        <h3 class="text-sm font-bold text-green-900 uppercase tracking-wider mb-1">Impacto Clim√°tico</h3>
                        <div class="flex items-baseline">
                            <span id="valOffsets" class="text-3xl font-extrabold text-green-700 mr-2">0</span>
                            <span class="text-green-600 font-medium">tCO2e / a√±o</span>
                        </div>
                        <p class="text-xs text-green-500 mt-1">Carbono secuestrado</p>
                    </div>
                </div>

                <div id="feedstockFeasibilityCard" class="dashboard-card">
                    <h3 class="section-title section-title-gray">Posici√≥n de Costos de Entrada</h3>
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">Costo Total Entregado (Compra + Log√≠stica)</p>
                            <div class="flex items-center">
                                <span id="valDeliveredCost" class="text-3xl font-extrabold text-gray-900">$0</span>
                                <span class="text-gray-600 ml-2 font-medium">por tonelada</span>
                                <div class="tooltip-container ml-2"><span class="f-icon">f</span><span class="tooltip-text">**F√≥rmula:**<br>(Gasto Total Materia Prima + Log√≠stica) / Total Toneladas</span></div>
                            </div>
                        </div>
                        <div id="feasibilityBadge" class="mt-4 md:mt-0 px-4 py-2 rounded-full font-bold text-sm uppercase bg-gray-200 text-gray-700">
                            Calculando...
                        </div>
                    </div>
                    <p id="feasibilityMsg" class="text-sm mt-3 text-gray-600 italic">
                        Comparando sus costos con referencias de la industria...
                    </p>
                </div>

                <div class="dashboard-card">
                    <h3 class="section-title section-title-gray">Resumen Financiero Anual</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <tbody class="divide-y divide-gray-100">
                                <tr class="bg-green-50">
                                    <td class="py-3 px-2 font-bold text-green-900 flex items-center">Ingresos Totales<div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Biochar + Cr√©ditos + Vinagre</span></div></td>
                                    <td id="summRevenue" class="py-3 px-2 text-right font-bold text-green-700">$0</td>
                                </tr>
                                <tr><td class="py-2 px-4 text-gray-600 pl-8">- Venta de Biochar</td><td id="revBiochar" class="py-2 px-4 text-right text-gray-900">$0</td></tr>
                                <tr><td class="py-2 px-4 text-gray-600 pl-8">- Cr√©ditos de Carbono</td><td id="revCredits" class="py-2 px-4 text-right text-gray-900">$0</td></tr>
                                <tr><td class="py-2 px-4 text-gray-600 pl-8">- Venta de Vinagre</td><td id="revVinegar" class="py-2 px-4 text-right text-gray-900">$0</td></tr>
                                
                                <tr class="bg-red-50">
                                    <td class="py-3 px-2 font-bold text-red-900 flex items-center">Costos Operativos Totales (OPEX)<div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Suma de costos abajo.</span></div></td>
                                    <td id="summOpex" class="py-3 px-2 text-right font-bold text-red-700">$0</td>
                                </tr>
                                <tr><td class="py-2 px-4 text-gray-600 pl-8">- Compra Materia Prima</td><td id="opexFeedstock" class="py-2 px-4 text-right text-gray-900">$0</td></tr>
                                <tr><td class="py-2 px-4 text-gray-600 pl-8">- Log√≠stica Materia Prima</td><td id="opexLogistics" class="py-2 px-4 text-right text-gray-900">$0</td></tr>
                                <tr><td class="py-2 px-4 text-gray-600 pl-8">- Operaciones Sitio (Labor, Mant, MRV)</td><td id="opexSiteOps" class="py-2 px-4 text-right text-gray-900">$0</td></tr>
                                <tr><td class="py-2 px-4 text-gray-600 pl-8">- Costos Venta y Vinagre</td><td id="opexRetailVinegar" class="py-2 px-4 text-right text-gray-900">$0</td></tr>
                                <tr><td class="py-2 px-4 text-gray-600 pl-8">- Costos Financieros (Intereses)</td><td id="opexFinance" class="py-2 px-4 text-right text-gray-900">$0</td></tr>
                                
                                <tr class="bg-gray-50 font-bold">
                                    <td class="py-3 px-2 flex items-center">Beneficio Antes de Impuestos<div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Ingresos - OPEX</span></div></td>
                                    <td id="summPreTax" class="py-3 px-2 text-right">$0</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-2 text-gray-600 flex items-center">- Impuesto Corporativo<div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Beneficio * Tasa Impuesto (min 0)</span></div></td>
                                    <td id="summTax" class="py-2 px-2 text-right text-red-600">$0</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-2 text-gray-600 flex items-center">+ Incentivos/Subvenciones</td>
                                    <td id="summIncentives" class="py-2 px-2 text-right text-green-600">$0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 print-me">
                <div class="dashboard-card bg-gray-50 h-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Indicadores Clave de Riesgo</h3>
                    <div id="kpiContainer" class="space-y-4">
                        <p class="text-gray-500 text-center italic">Cargando evaluaci√≥n de riesgos...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-card bg-yellow-50 border-2 border-yellow-200 mb-6 print-me">
            <h3 class="section-title section-title-yellow">Plan de Acci√≥n del Proyecto (Notas Consolidadas)</h3>
            <div id="actionPlanContainer" class="space-y-2">
                <p class="text-gray-500 italic">No hay elementos de acci√≥n marcados en herramientas anteriores.</p>
            </div>
        </div>
        
        <div id="printSummary" class="print-only dashboard-card">
            </div>
        <div class="nav-grid mt-8 mb-12">
            <a href="tool5_es.html" class="nav-button nav-button-blue md:col-span-1">‚Üê Volver a Herramienta 5</a>
            <button onclick="window.print()" class="nav-button nav-button-green md:col-span-1">üñ®Ô∏è Imprimir / Guardar como PDF</button>
            <a href="tool7_es.html" class="nav-button nav-button-green md:col-span-1">Ir a Escenarios ‚Üí</a>
        </div>
        <div class="text-center">
             <a href="index_es.html" class="text-sm text-gray-600 hover:text-blue-600 font-medium">‚Üê Volver al Men√∫ Principal</a>
        </div>
    </div>

    <div class="disclaimer-container"> <footer class="disclaimer max-w-5xl mx-auto">
            <p><strong>Sin Garant√≠a:</strong> <em>Las proyecciones proporcionadas por esta calculadora se basan en las suposiciones y datos ingresados por el usuario. Son solo para fines ilustrativos y no constituyen una garant√≠a de costos reales, ingresos o rentabilidad.</em></p>
            <p><strong>No es Asesoramiento Financiero:</strong> <em>La informaci√≥n proporcionada no pretende sustituir el asesoramiento profesional financiero, legal o agr√≠cola. Los usuarios son los √∫nicos responsables de las decisiones tomadas en base a los resultados de esta herramienta.</em></p>
            <p><strong>Verificar Todos los Datos:</strong> <em>Los usuarios deben verificar independientemente todos los costos locales, precios de mercado y requisitos regulatorios antes de realizar cualquier inversi√≥n.</em></p>
        </footer>
    </div>

<script type="module">
        let projectData = {};

        // --- Helper Functions ---
        function setText(id, txt) { 
            const el = document.getElementById(id);
            if (el) el.textContent = txt; 
        }
        function formatMoney(n) { 
            if (isNaN(n) || !isFinite(n)) n = 0;
            return "$" + Math.round(n).toLocaleString(); 
        }
        function formatTons(n) { 
            if (isNaN(n) || !isFinite(n)) n = 0;
            return n.toLocaleString(undefined, {maximumFractionDigits: 1}); 
        }
        function colorHero(id, isGood, isBad) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('text-green-600', 'text-red-600', 'text-gray-900');
            if (isGood) el.classList.add('text-green-600');
            else if (isBad) el.classList.add('text-red-600');
            else el.classList.add('text-gray-900');
        }
        function calculateNPV(invest, flow, rate, years) {
            let npv = -invest;
            if (rate <= -1) return -Infinity; // Avoid division by zero if rate is -100%
            for (let t = 1; t <= years; t++) { 
                npv += flow / Math.pow(1 + rate, t); 
            }
            return npv;
        }

        // --- Matrix Data (Embedded in Tool 6 for KPI lookup) ---
        const COUNTRY_DATA = {
            "bolivia": { permit: { time: "4‚Äì8 meses" } },
            "brazil": { permit: { time: "6-9 meses" } },
            "colombia": { permit: { time: "6 meses" } },
            "costa_rica": { permit: { time: "6‚Äì12 meses" } },
            "dominican_republic": { permit: { time: "3‚Äì6 meses" } },
            "ecuador": { permit: { time: "6‚Äì12 meses" } },
            "el_salvador": { permit: { time: "3‚Äì6 meses" } },
            "guatemala": { permit: { time: "6‚Äì12 meses" } },
            "honduras": { permit: { time: "6‚Äì12 meses" } },
            "mexico": { permit: { time: "3‚Äì6 meses" } },
            "nicaragua": { permit: { time: "4‚Äì8 meses" } },
            "panama": { permit: { time: "6‚Äì12 meses" } },
            "peru": { permit: { time: "4‚Äì8 meses" } },
            "custom": { permit: { time: "Desconocido" } }
        };

        // --- Data Loading & Calculation ---
        document.addEventListener('DOMContentLoaded', () => {
            if (window.BiocharEngine) {
                projectData = BiocharEngine.loadProjectData() || {};
            } else {
                const storedData = localStorage.getItem('biocharProjectData');
                if (storedData) projectData = JSON.parse(storedData);
            }
            
            // Check for required tools
            const missingTools = [];
            if (!projectData.tool1) missingTools.push("Herramienta 1");
            if (!projectData.tool2) missingTools.push("Herramienta 2");
            if (!projectData.tool3) missingTools.push("Herramienta 3");
            if (!projectData.tool4) missingTools.push("Herramienta 4");
            if (!projectData.tool5) missingTools.push("Herramienta 5");

            if (missingTools.length === 0) {
                loadAndCalculate();
            } else {
                const errorMsg = `Faltan datos de las siguientes herramientas: ${missingTools.join(', ')}. Por favor regrese y guarde los datos.`;
                document.getElementById('loadingIndicator').textContent = errorMsg;
                document.getElementById('loadingIndicator').classList.remove('animate-pulse', 'text-blue-600');
                document.getElementById('loadingIndicator').classList.add('text-red-600');
                document.getElementById('kpiContainer').innerHTML = "<p class='text-gray-500 text-center italic'>No se encontraron datos.</p>";
            }
        });

        function loadAndCalculate() {
            try {
                // === 1. EXTRACT DATA FROM ALL TOOLS (with defaults) ===
                const t1 = projectData.tool1 || {};
                const t2 = projectData.tool2 || {};
                const t3 = projectData.tool3 || {};
                const t4 = projectData.tool4 || {};
                const t5 = projectData.tool5 || {};

                // Create safe-access objects for nested data
                const f_data = t2.diversified || {};
                const k_data = t2.kiln || {};
                const c_data = t5.capex || {};
                const o_data = t5.opex || {};
                const fin_data = t5.finance || {};

                // === 2. CALCULATE TOTALS (LOGIC SYNCED WITH TOOL 7) ===

                // --- FEEDSTOCK & BIOCHAR (from T2) ---
                const biochar1 = (f_data.f1_tonnes || 0) * (1 - (f_data.f1_ash || 0)) * (f_data.f1_yield || 0);
                const biochar2 = (f_data.f2_tonnes || 0) * (1 - (f_data.f2_ash || 0)) * (f_data.f2_yield || 0);
                const totalBiochar = biochar1 + biochar2;

                const credits1 = biochar1 * (f_data.f1_carbon || 0) * (f_data.f1_conv || 0);
                const credits2 = biochar2 * (f_data.f2_carbon || 0) * (f_data.f2_conv || 0);
                const totalCredits = credits1 + credits2;
                
                const totalFeedstock = (f_data.f1_tonnes || 0) + (f_data.f2_tonnes || 0);

                // --- CAPEX (from T2 & T5) ---
                const totalCapex = c_data.totalCapex || 0; // Use the pre-calculated total from Tool 5

                // --- REVENUE (from T4) ---
                const rev_Credits = totalCredits * (t4.carbonCreditPrice || 0);
                
                let rev_Biochar = 0;
                let opex_RetailCosts = 0; // Compost, packaging, etc.
                const mixPercent = (t4.retailMixPercent || 0) / 100; // Define mixPercent
                
                // *** FIX: Per-Bag Logic ***
                if (t4.salesModel === 'retail' && mixPercent > 0 && (t4.retailBagWeightKg || 0) > 0) {
                    const biocharPerBagKg = t4.retailBagWeightKg * mixPercent;
                    const totalBags = (totalBiochar * 1000) / biocharPerBagKg; // Convert tonnes to kg
                    
                    rev_Biochar = totalBags * (t4.retailPricePerBag || 0);
                    
                    const compostTonnes = (totalBags * (t4.retailBagWeightKg * (1 - mixPercent))) / 1000;
                    
                    opex_RetailCosts = (compostTonnes * (t4.compostCost || 0)) +
                                     (totalBags * (t4.retailPackagingCostPerBag || 0)) +
                                     (totalBags * (t4.retailDistributionCostPerBag || 0));
                } else if (t4.salesModel === 'bulk') {
                    rev_Biochar = totalBiochar * (t4.bulkPrice || 0);
                }
                rev_Biochar = rev_Biochar * (t4.salesRate || 1); // Apply sales rate

                let rev_Vinegar = 0;
                let opex_VinegarCosts = 0;
                if (t4.sellWoodVinegar) {
                    const totalLitres = totalFeedstock * (t4.woodVinegarYield || 0);
                    rev_Vinegar = totalLitres * (t4.woodVinegarPrice || 0) * (t4.salesRate || 1); // Apply sales rate
                    opex_VinegarCosts = totalLitres * ((t4.woodVinegarPackaging || 0) + (t4.woodVinegarDistribution || 0));
                }

                const totalRevenue = rev_Credits + rev_Biochar + rev_Vinegar;

                // --- OPEX (from T2, T3, T4, T5) ---
                // *** FIX: Default prices to 0 ***
                const opex_Feedstock = ((f_data.f1_tonnes || 0) * (f_data.f1_price || 0)) + ((f_data.f2_tonnes || 0) * (f_data.f2_price || 0));
                const opex_Logistics = t3.totalAnnualLogisticsCost || 0;
                const opex_Marketing = t4.marketingBudget || 0;
                const opex_RetailCompliance = t4.soilAmendmentAnnualCost || 0;

                let opex_Labor = (o_data.generalStaffCount * o_data.generalSalary) + (o_data.mgmtStaffCount * o_data.mgmtSalary);
                let opex_Utilities = (o_data.utilities || 0);
                
                // *** FIX: Only reduce months if Strategy is 'Shutdown', ignore 'Store' ***
                if (t1.seasonalityStrategy === 'shutdown') {
                    const months = (o_data.monthsOperational || 12);
                    opex_Labor = opex_Labor * (months / 12);
                    opex_Utilities = opex_Utilities * (months / 12);
                }

                // *** UPDATED: Includes new OPEX lines ***
                const opex_SiteOps = opex_Labor + 
                                     (o_data.insurance || 0) + 
                                     opex_Utilities + 
                                     (o_data.pickupsAnnualOpex || 0) +
                                     (o_data.regulatory || 0) +
                                     (o_data.registryFees || 0) +
                                     (o_data.mrvAnnual || 0) +
                                     (o_data.landLease || 0) +
                                     (o_data.totalMobileRelocationOpex || 0);
                
                const opex_Finance = (o_data.hasFeedstockLoan ? (o_data.feedstockWorkingCapital * (o_data.feedstockLoanInterestRate / 100)) : 0) +
                                     (fin_data.loanAmount * (fin_data.interestRate / 100));

                const totalOpex = opex_Feedstock + 
                                  opex_Logistics + 
                                  opex_SiteOps + 
                                  opex_RetailCosts + 
                                  opex_VinegarCosts + 
                                  opex_Marketing + 
                                  opex_RetailCompliance + 
                                  opex_Finance;

                // --- FINAL FINANCIALS ---
                const preTaxProfit = totalRevenue - totalOpex;
                const tax = Math.max(0, preTaxProfit * (fin_data.taxRate / 100));
                const incentives = (fin_data.incentives || 0);
                const netProfit = preTaxProfit - tax + incentives;
                
                const projectLife = fin_data.projectLife || 10;
                const paybackYears = netProfit > 0 ? (totalCapex / netProfit) : Infinity; // Fix div by zero
                const npv = calculateNPV(totalCapex, netProfit, (fin_data.discountRate / 100), projectLife);

                // === 3. RENDER ===
                setText('npvYears', `${projectLife}-A√±os`);
                colorHero('heroCapex', false, true); // Capex is always a "cost"
                setText('heroCapex', formatMoney(totalCapex));
                colorHero('heroProfit', netProfit >= 0, netProfit < 0);
                setText('heroProfit', formatMoney(netProfit));
                // *** FIX: Check for Infinity ***
                setText('heroPayback', !isFinite(paybackYears) ? "Nunca" : `${paybackYears.toFixed(1)} A√±os`);
                colorHero('heroPayback', paybackYears <= 5, paybackYears > 10);
                colorHero('heroNpv', npv >= 0, npv < 0);
                setText('heroNpv', formatMoney(npv));

                setText('valBiochar', formatTons(totalBiochar));
                setText('valOffsets', formatTons(totalCredits));

                // Feasibility
                const deliveredCostPerTonne = totalFeedstock > 0 ? ((opex_Feedstock + opex_Logistics) / totalFeedstock) : 0;
                renderFeasibility(deliveredCostPerTonne); // *** FIX: New logic here ***

                // Financial Summary Table
                setText('summRevenue', formatMoney(totalRevenue));
                setText('revBiochar', formatMoney(rev_Biochar));
                setText('revCredits', formatMoney(rev_Credits));
                setText('revVinegar', formatMoney(rev_Vinegar));
                
                setText('summOpex', formatMoney(totalOpex));
                setText('opexFeedstock', formatMoney(opex_Feedstock));
                setText('opexLogistics', formatMoney(opex_Logistics));
                setText('opexSiteOps', formatMoney(opex_SiteOps));
                setText('opexRetailVinegar', formatMoney(opex_RetailCosts + opex_VinegarCosts + opex_Marketing + opex_RetailCompliance));
                setText('opexFinance', formatMoney(opex_Finance));
                
                setText('summPreTax', formatMoney(preTaxProfit));
                setText('summTax', formatMoney(tax));
                setText('summIncentives', formatMoney(incentives));

                // Render KPIs and Notes
                renderKPIs(t1, t2, t4, t5);
                renderActionPlan(projectData);
                renderPrintSummary(projectData); 
                
                document.getElementById('loadingIndicator').classList.add('hidden');

            } catch (e) { 
                console.error("Error during dashboard calculation:", e); 
                document.getElementById('loadingIndicator').textContent = "Ocurri√≥ un error durante el c√°lculo. Por favor verifique las herramientas anteriores.";
                document.getElementById('loadingIndicator').classList.remove('animate-pulse', 'text-blue-600');
                document.getElementById('loadingIndicator').classList.add('text-red-600');
            }
        }

        function renderFeasibility(perTonne) {
            // *** FIX: Handle NaN/0 ***
            if (isNaN(perTonne)) perTonne = 0; 
            
            document.getElementById('valDeliveredCost').textContent = formatMoney(perTonne);
            const badge = document.getElementById('feasibilityBadge');
            const msg = document.getElementById('feasibilityMsg');
            
            // *** UPDATED TEXT: Favorable / Less Favorable ***
            if (perTonne <= 0) {
                badge.className = "mt-4 md:mt-0 px-4 py-2 rounded-full font-bold text-sm uppercase bg-green-100 text-green-800";
                badge.textContent = "Altamente Favorable";
                msg.textContent = "Su materia prima es gratis ($0/t). Esto le da una fuerte ventaja competitiva.";
            } else if (perTonne < 20) {
                badge.className = "mt-4 md:mt-0 px-4 py-2 rounded-full font-bold text-sm uppercase bg-green-100 text-green-800";
                badge.textContent = "Altamente Favorable";
                msg.textContent = "Su costo de entrega es excelente (<$20/t). Fuerte ventaja competitiva.";
            } else if (perTonne <= 40) {
                badge.className = "mt-4 md:mt-0 px-4 py-2 rounded-full font-bold text-sm uppercase bg-blue-100 text-blue-800";
                badge.textContent = "Favorable";
                msg.textContent = "Su costo de entrega es est√°ndar ($20-$40/t). La rentabilidad depender√° de su modelo de ventas.";
            } else if (perTonne <= 60) {
                badge.className = "mt-4 md:mt-0 px-4 py-2 rounded-full font-bold text-sm uppercase bg-yellow-100 text-yellow-800";
                badge.textContent = "Marginal";
                msg.textContent = "Su costo de entrega es alto ($40-$60/t). Es sensible a ca√≠das de precio del biochar.";
            } else {
                badge.className = "mt-4 md:mt-0 px-4 py-2 rounded-full font-bold text-sm uppercase bg-red-100 text-red-800";
                badge.textContent = "Menos Favorable";
                msg.textContent = "Su costo de entrega es >$60/t. El transporte y la materia prima pueden reducir su ganancia.";
            }
        }

        // *** NEW: Fully Revised KPI Function ***
        function renderKPIs(t1, t2, t4, t5) {
            const kpiContainer = document.getElementById('kpiContainer'); 
            kpiContainer.innerHTML = ''; // Clear loader
            
            // 1. Permit Timeline (NEW)
            const country = t1.country || "custom";
            const countryInfo = COUNTRY_DATA[country] || COUNTRY_DATA["custom"];
            const leadTime = countryInfo.permit?.time || "Desconocido";
            addKPI('blue', `Cronograma de Permisos: ${leadTime}`, `Basado en tiempos t√≠picos de permisos de aire para ${country.toUpperCase().replace('_',' ')}. Planifique su lanzamiento acorde.`);

            // 2. Community Buy-In (from T1)
            const buyIn = t1.communityBuyIn || 'not_secured';
            if (buyIn === 'secured') {
                addKPI('green', 'Apoyo Comunitario: Asegurado', 'Excelente. Una base s√≥lida para el √©xito.');
            } else if (buyIn === 'in_process') {
                addKPI('yellow', 'Apoyo Comunitario: En Proceso', 'Riesgo clave. Contin√∫e construyendo relaciones locales.');
            } else {
                addKPI('red', 'Apoyo Comunitario: No Asegurado', 'Alto riesgo. Los proyectos sin apoyo comunitario a menudo fallan.');
            }

            // 3. Feedstock Risk (from T2)
            const f1_comp = t2.diversified?.f1_competition;
            const f1_cont = t2.diversified?.f1_contract;
            let isHighRisk = (f1_cont === 'spot');
            let isMedRisk = (f1_cont === 'written' || f1_cont === 'verbal' || f1_comp === 'high' || f1_comp === 'moderate');
            
            if (t1.seasonalityStrategy === 'diversify') {
                const f2_comp = t2.diversified?.f2_competition;
                const f2_cont = t2.diversified?.f2_contract;
                if (f2_cont === 'spot') isHighRisk = true;
                if (f2_cont === 'written' || f2_cont === 'verbal' || f2_comp === 'high' || f2_comp === 'moderate') isMedRisk = true;
            }

            if (isHighRisk) {
                addKPI('red', 'RIESGO CR√çTICO: Suministro', 'Depender del mercado spot es un riesgo cr√≠tico. Asegurar la materia prima es el desaf√≠o #1.');
            } else if (isMedRisk) {
                addKPI('yellow', 'Riesgo Suministro: Moderado', 'Competencia moderada o contratos informales. Sus costos pueden ser impredecibles.');
            } else {
                addKPI('green', 'Riesgo Suministro: Bajo', 'Materia prima asegurada por propiedad o contrato escrito.');
            }
            
            // 4. Marketing Plan (from T4)
            const marketing = t4.marketingPlan;
            if (marketing === 'coop') {
                addKPI('green', 'Plan Ventas: Asegurado', 'Distribuci√≥n integrada (como una cooperativa) es el modelo de menor riesgo.');
            } else if (marketing === 'contract') {
                addKPI('yellow', 'Plan Ventas: Riesgo Moderado', 'Contrato regional es bueno, pero depende del desempe√±o de su socio.');
            } else {
                addKPI('red', 'Plan Ventas: Alto Riesgo', 'Sin plan de marketing. Esta es una brecha cr√≠tica.');
            }

            // 5. Pyrolyzer Cost Basis (from T2)
            const kilnBasis = t2.kiln?.pyrolyzer_cost_basis;
            if (kilnBasis === 'manufacturer_quote') {
                addKPI('green', 'Costo Pirolizador: Confirmado', 'Costos basados en cotizaci√≥n, haciendo su CAPEX confiable.');
            } else {
                addKPI('yellow', 'Costo Pirolizador: Estimado', 'Su CAPEX es una estimaci√≥n. Obtenga una cotizaci√≥n oficial.');
            }

            // 6. MRV Cost Basis (from T5)
            const mrvBasis = t5.certSource;
            if (mrvBasis === 'quote') {
                addKPI('green', 'Costo MRV: Confirmado', 'Costos basados en cotizaci√≥n, haciendo su OPEX confiable.');
            } else {
                addKPI('yellow', 'Costo MRV: Estimado', 'Sus costos MRV son estimados. Confirme este costo.');
            }
            
            // 7. Lab Results (from T2)
            const labBasis = t2.kiln?.carbonDataBasis;
            if (labBasis === 'lab_results') {
                addKPI('green', 'Datos de Carbono: Confirmados', 'Proyecciones basadas en resultados de laboratorio confiables.');
            } else {
                addKPI('red', 'Datos de Carbono: Alto Riesgo', 'Proyecciones basadas en valores gen√©ricos. Obtenga pruebas de laboratorio para confirmar rentabilidad.');
            }
            
            // 8. Deforestation Risk (from T2)
            if (t2.diversified?.f2_isWood) {
                addKPI('red', 'Riesgo Deforestaci√≥n', 'Usar biomasa le√±osa requiere auditor√≠a estricta para probar que es residuo. Mitigaci√≥n: Cl√°usulas de trazabilidad.');
            }

            // 9. Seasonal Strategy (from T1)
            if (t1.seasonalityStrategy === 'shutdown') {
                addKPI('red', 'Riesgo Estrategia: Alto', 'Cierres estacionales suelen ser inviables por baja utilizaci√≥n del equipo.');
            } else if (t1.seasonalityStrategy === 'store') {
                addKPI('yellow', 'Riesgo Estrategia: Moderado', 'Almacenar requiere capital de trabajo significativo y riesgo de p√©rdida de material.');
            }
        }

        function addKPI(color, title, msg) {
            const kpiContainer = document.getElementById('kpiContainer');
            const colors = { green: 'kpi-green', yellow: 'kpi-yellow', red: 'kpi-red', blue: 'kpi-blue' };
            const div = document.createElement('div');
            div.className = `kpi-card ${colors[color]}`;
            div.innerHTML = `<h4 class="kpi-title">${title}</h4><p class="kpi-desc">${msg}</p>`;
            kpiContainer.appendChild(div);
        }

        // *** NEW: Robust Notes Function ***
        function renderActionPlan(data) {
            const container = document.getElementById('actionPlanContainer');
            container.innerHTML = ''; 

            // Helper to safely fetch notes from multiple possible locations
            const getNote = (toolData, key) => {
                if (!toolData) return '';
                return toolData[key] || '';
            }

            const notes = {
                t1: getNote(data.tool1, 'notes_T1'),
                t2: getNote(data.tool2, 'notes_T2'),
                t3: getNote(data.tool3, 'notes_T3'), 
                t4: getNote(data.tool4, 'notes_T4'),
                t5: data.notes_T5, 
                t7: data.notes_T7
            };

            let hasNotes = false;
            const toolNames = {
                t1: "Herr 1: Escala",
                t2: "Herr 2: Producci√≥n",
                t3: "Herr 3: Log√≠stica",
                t4: "Herr 4: Ingresos",
                t5: "Herr 5: Finanzas",
                t7: "Herr 7: Escenarios"
            };

            for (const [key, val] of Object.entries(notes)) {
                if (val && val.trim() !== "") {
                    hasNotes = true;
                    const div = document.createElement('div');
                    div.className = 'action-item';
                    div.innerHTML = `<span class="action-source">${toolNames[key]}:</span> ${val.replace(/\n/g, '<br>')}`;
                    container.appendChild(div);
                }
            }

            if (!hasNotes) {
                container.innerHTML = '<p class="text-gray-500 italic">No hay elementos de acci√≥n marcados en herramientas anteriores.</p>';
            }
        }

        // *** NEW: Print Summary Function ***
        function renderPrintSummary(data) {
            const container = document.getElementById('printSummary');
            if (!container) return;

            let html = '<h2>Resumen Detallado de Datos</h2>';
            
            const createTable = (title, toolData) => {
                if (!toolData || Object.keys(toolData).length === 0) return '';
                let table = `<h3>${title}</h3><table><thead><tr><th>Entrada</th><th>Valor</th></tr></thead><tbody>`;
                
                // Custom formatting for cleaner output
                const formatValue = (key, val) => {
                    if (typeof val === 'number') {
                        if (key.includes('Price') || key.includes('Cost') || key.includes('Salary') || key.includes('Capex') || key.includes('loan') || key.includes('feedstockWorkingCapital') || key.includes('subtotal') || key.includes('prepayment')) {
                            return formatMoney(val);
                        }
                        if (key.includes('tonnes') || key.includes('Percent') || key.includes('Rate') || key.includes('Yield') || key.includes('percent') || key.includes('BagWeight')) {
                            return val.toLocaleString(undefined, {maximumFractionDigits: 2});
                        }
                    }
                    if (typeof val === 'boolean') {
                        return val ? 'S√≠' : 'No';
                    }
                    if (typeof val === 'string' && val.length > 50) {
                        return val.substring(0, 50) + '...'; // Truncate long notes
                    }
                    if (val === null || val === undefined) {
                        return '--';
                    }
                    return val;
                };

                for (const [key, val] of Object.entries(toolData)) {
                    if (key === 'diversified' || key === 'kiln' || key === 'capex' || key === 'opex' || key === 'finance') {
                         for (const [subKey, subVal] of Object.entries(val)) {
                            table += `<tr><td>${key} &gt; ${subKey}</td><td>${formatValue(subKey, subVal)}</td></tr>`;
                        }
                    } else if (Array.isArray(val)) {
                         table += `<tr><td>${key}</td><td>${val.length} entradas (ver herramienta)</td></tr>`;
                    } else if (key !== 'lastUpdated' && !key.startsWith('notes_')) { // Filter out keys
                        table += `<tr><td>${key}</td><td>${formatValue(key, val)}</td></tr>`;
                    }
                }
                table += '</tbody></table>';
                return table;
            };

            html += createTable('Herr 1: Configuraci√≥n', data.tool1);
            html += createTable('Herr 2: Producci√≥n', data.tool2);
            html += createTable('Herr 3: Log√≠stica', data.tool3);
            html += createTable('Herr 4: Ingresos', data.tool4);
            html += createTable('Herr 5: CAPEX/OPEX', data.tool5);
            
            container.innerHTML = html;
        }

    </script>
</body>
</html>