<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas y Operaciones (Herramienta 5)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="engine.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f4f5; }
        
        /* Visual Grouping */
        .input-section { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6; }

        /* Headers */
        .section-title { @apply text-xl font-bold pb-2 border-b mb-4; }
        .section-title-orange { @apply text-orange-700 border-orange-200; }
        .section-title-yellow { @apply text-yellow-900 border-yellow-300; }
        .section-title-blue { @apply text-blue-900 border-blue-200; }
        .section-title-gray { @apply text-gray-800 border-gray-300; }
        .section-title-green { @apply text-green-800 border-green-300; }

        .label-text { @apply block text-sm font-medium text-gray-700 mb-1; }
        
        /* Input Fields */
        .input-field { 
            @apply mt-1 block w-full rounded-md border-gray-400 shadow-sm p-3 bg-white focus:border-green-500 focus:ring-green-500 transition duration-150 box-border; 
            color: #000; cursor: text;
        }
        .input-field[readonly] { 
            @apply bg-gray-100 text-gray-500 cursor-not-allowed;
            font-weight: 500;
        }

        /* --- TOOLTIPS & ICONS --- */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; cursor: help; vertical-align: middle; }
        .f-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #6b7280; color: white; border-radius: 50%; font-family: 'Georgia', serif; font-style: italic; font-weight: bold; font-size: 14px; line-height: 1; padding-bottom: 2px; margin-left: 6px; }
        .tooltip-icon { width: 16px; height: 16px; background-color: #9ca3af; color: white; font-size: 10px; font-weight: bold; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 6px; }

        .tooltip-text { position: absolute; width: 240px; background-color: #374151; color: white; font-size: 0.75rem; padding: 10px; border-radius: 6px; bottom: 150%; left: 50%; transform: translateX(-50%); visibility: hidden; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 50; font-weight: normal; text-align: left; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        .hidden { display: none; }

        /* --- PROGRESS BAR --- */
        .progress-bar-container { @apply w-full bg-gray-200 rounded-full h-2.5 mb-6; }
        .progress-bar { @apply bg-green-600 h-2.5 rounded-full transition-all duration-500; }
        
        /* --- FOOTER --- */
        .disclaimer { text-align: left; font-size: 0.75rem; color: #6b7280; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; }
        .disclaimer p { margin-bottom: 0.5rem; font-style: italic; }
        .disclaimer strong { font-weight: 600; color: #4b5563; font-style: normal; }

        /* --- NAVIGATION BUTTONS --- */
        .nav-grid { @apply grid grid-cols-2 md:grid-cols-3 gap-3 items-center; }
        .nav-button { display: inline-block; padding: 12px 20px; font-weight: 700; border: none; border-radius: 12px; font-size: 0.875rem; cursor: pointer; transition: opacity 0.2s; text-decoration: none; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .nav-button:hover { opacity: 0.9; }
        .nav-button-blue { background-color: #2563eb; color: white; }
        .nav-button-green { background-color: #16a34a; color: white; }
        .nav-button-indigo { background-color: #4f46e5; color: white; }
        .nav-button-white { background-color: white; color: #2563eb; border: 2px solid #dbeafe; }
        .nav-button-white:hover { background-color: #f9fafb; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-extrabold text-green-700">Calculadora de Viabilidad de Biochar</h1>
            <h2 class="text-lg font-medium text-gray-700 mt-1">para Cadenas de Suministro de Café y Cacao en América Latina</h2>
            <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mt-4">Climatebase Fellowship Cohort 8 - Proyecto Capstone</p>
            <p class="text-xs font-medium text-gray-500 mt-2">(Todos los valores en USD)</p>
            
            <div class="mt-4 mb-6">
                <a href="https://chatgpt.com/g/g-691ea2b1c2888191b85e54e203c53b2f-biochar-feasibility-guide" 
                   target="_blank" 
                   class="inline-block bg-blue-50 text-blue-700 hover:text-blue-900 border border-blue-200 rounded-full px-4 py-1 text-sm font-medium transition">
                    ¿Preguntas? Haz clic aquí para consultar al Asistente IA de Biochar ↗
                </a>
            </div>

            <p class="text-lg font-medium text-green-800">Herramienta 5: CAPEX y OPEX</p>
        </header>

        <div class="w-full mb-8">
            <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                <span>Paso 5 de 7: Finanzas y Operaciones</span>
                <span>(Siguiente: Panel)</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 71.4%"></div>
            </div>
        </div>

        <div class="input-section">
            <h2 class="section-title section-title-orange">Capital de Trabajo y Financiamiento</h2>
            <div class="bg-white p-4 rounded-lg border border-orange-200 mb-4">
                <label class="block">
                    <span class="label-text font-bold text-gray-800">Monto a Financiar (Capital de Trabajo)</span>
                    <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Precargado con Costo de Compra de Materia Prima (Herramienta 2) + Logística (Herramienta 3). Ajuste si solo necesita financiar una parte.</span></div>
                    <div class="flex items-center mt-1">
                        <input type="number" id="inputFeedstockLoanAmount" class="input-field font-bold text-orange-800 border-2 border-orange-300" min="0" placeholder="Calculando...">
                    </div>
                </label>
            </div>
            <div class="space-y-4">
                <label class="flex items-center space-x-3 bg-white p-3 rounded border border-orange-200 cursor-pointer">
                    <input type="checkbox" id="checkFeedstockLoan" class="h-5 w-5 text-orange-600 focus:ring-orange-500">
                    <span class="font-medium text-gray-800">¿Necesita una Línea de Crédito para esto?</span>
                </label>
                <div id="feedstockLoanDetails" class="hidden pl-4 border-l-2 border-orange-300">
                    <label class="block">
                        <span class="label-text">Tasa de Interés Anual (Línea de Crédito %)</span>
                        <input type="number" id="inputFeedstockInterest" value="15" class="input-field w-32" min="0">
                    </label>
                    <p class="text-xs text-gray-500 mt-1">El interés se sumará a su OPEX anual.</p>
                </div>
            </div>
        </div>

        <div class="input-section">
            <h2 class="section-title section-title-yellow">Gastos de Capital Físico (CAPEX)</h2>
            
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 space-y-2 mb-6 text-sm">
                <div class="flex justify-between">
                        <p><span class="font-semibold">Escala del Proyecto:</span> <span id="displayScale">Cargando...</span></p>
                        <p><span class="font-semibold">País Base:</span> <span id="displayCountry">Cargando...</span></p>
                </div>
                <p><span class="font-semibold">Configuración:</span> <span id="displayProjectType">Cargando...</span> (<span id="displayHubs">1</span> centros)</p>
            </div>

            <div class="space-y-6">
                <div class="p-4 bg-white rounded-lg border border-gray-300 shadow-sm">
                    <label class="block">
                        <div class="flex justify-between items-center">
                            <span class="label-text font-semibold text-gray-700">Costo Inicial Total del Pirolizador (de Herr. 2)</span>
                            <div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Este valor se carga automáticamente de sus selecciones de horno y envío en la Herramienta 2.</span></div>
                        </div>
                        <input type="number" id="outputTotalKilnCost" value="0" class="input-field font-bold text-gray-800 text-lg border-2 border-blue-300" readonly>
                        <p id="kilnCostWarning" class="text-xs text-gray-500 mt-1 italic"></p>
                    </label>
                </div>

                <div id="woodChipperContainer" class="hidden p-4 bg-purple-50 border-2 border-purple-300 rounded-lg">
                    <label class="block">
                        <span class="label-text font-bold text-purple-900">Astilladora / Trituradora ($)</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Requerido para procesar materias primas leñosas (de Herramienta 2).</span></div>
                        <input type="number" id="inputWoodChipperCost" value="15000" class="input-field border-purple-300 font-bold text-purple-900" min="0">
                    </label>
                </div>
                
                <div id="storageInfraContainer" class="hidden p-4 bg-orange-50 border border-orange-200 rounded-lg">
                    <label class="block">
                        <span class="label-text font-bold text-orange-900">Infraestructura de Almacenamiento ($)</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Requerido para la estrategia de "Almacenamiento". Incluye cobertizos, lonas y plataformas.</span></div>
                        <input type="number" id="inputStorageInfra" value="10000" class="input-field border-orange-300" min="0">
                    </label>
                </div>

                <div class="space-y-4 p-4 bg-white rounded-lg border border-gray-200">
                    <h4 class="font-semibold text-gray-700">Secado y Equipos Auxiliares</h4>
                    <label class="block">
                        <span class="label-text">Secadora Mecánica ($)</span>
                        <input type="number" id="inputDryerCost" value="50000" min="0" class="input-field">
                    </label>
                    
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded border border-green-200">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="checkSyngasDucting" class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500">
                            <span class="ml-3 text-sm font-medium text-green-900">¿Usar calor residual de syngas para secadora?</span>
                        </label>
                        <div class="text-right">
                            <div class="flex justify-end items-center">
                                <div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">**Fórmula:**<br>(Costo Total Pirolizador) × 10%</span></div>
                                <span class="text-xs text-green-700 block ml-1">+10% costo pirolizador</span>
                            </div>
                            <span id="outputSyngasCost" class="font-bold text-green-800">$0</span>
                        </div>
                    </div>

                    <label class="block">
                        <span class="label-text">Otros Equipos Auxiliares ($)</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Balanzas, montacargas, transpaletas, etc.</span></div>
                        <input type="number" id="inputAncillaryCost" value="25000" min="0" class="input-field">
                    </label>
                </div>

                <div class="p-4 bg-white rounded-lg border border-gray-200 space-y-4">
                    <h4 class="font-semibold text-gray-700">Vehículos (CAPEX y OPEX)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
                            <label class="block">
                                <span class="label-text">1. Camiones Logísticos (CAPEX)</span>
                                <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Para camiones propios, el costo operativo (OPEX) se captura en la Herramienta 3.</span></div>
                                <em class="text-xs text-gray-500 block">Los "Camiones Propios" usados en la Herramienta 3.</em>
                            </label>
                            <label class="block">
                                <span class="label-text text-xs">Número de Camiones</span>
                                <input type="number" id="inputNumLogisticsTrucks" value="0" min="0" class="input-field">
                            </label>
                            <label class="block">
                                <span class="label-text text-xs">Costo Prom. por Camión ($)</span>
                                <input type="number" id="inputLogisticsTruckCost" value="40000" min="0" class="input-field">
                            </label>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
                            <label class="block">
                                <span class="label-text">2. Camionetas Pickups (CAPEX y OPEX)</span>
                                <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Los costos de reubicación de hornos móviles se capturan por separado abajo.</span></div>
                                <em class="text-xs text-gray-500 block">Para gerentes, agrónomos, tareas generales o remolque de hornos móviles.</em>
                            </label>
                            <label class="block">
                                <span class="label-text text-xs">Número de Pickups</span>
                                <input type="number" id="inputNumPickups" value="1" min="0" class="input-field">
                            </label>
                            <label class="block">
                                <span class="label-text text-xs">Costo Prom. por Pickup ($)</span>
                                <input type="number" id="inputPickupCost" value="30000" min="0" class="input-field">
                            </label>
                            <label class="block pt-2 border-t border-gray-300">
                                <span class="label-text text-xs font-semibold">OPEX Anual de Pickups ($/año)</span>
                                <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Combustible, mantenimiento y seguro para vehículos generales del sitio.</span></div>
                                <input type="number" id="inputPickupsOpex" value="3000" min="0" class="input-field">
                            </label>
                        </div>
                    </div>
                </div>

                <div id="mobileRelocationContainer" class="hidden p-4 bg-white rounded-lg border border-gray-300 shadow-sm space-y-4">
                    <h4 class="font-semibold text-gray-800">Reubicación de Hornos Móviles (OPEX)</h4>
                    <p class="text-xs text-gray-500 italic">Costos por mover su(s) horno(s) móvil(es) entre sitios. El número de hornos se carga de la Herramienta 2.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="label-text">Número de Hornos Móviles</span>
                            <input type="number" id="inputNumMobileKilns" class="input-field" readonly>
                        </label>
                        <label class="block">
                            <span class="label-text">Reubicaciones por Horno al Año</span>
                            <input type="number" id="inputRelocationsPerKiln" value="4" min="0" class="input-field">
                        </label>
                        <label class="block">
                            <span class="label-text">Tiempo Prom. por Reubicación (Horas)</span>
                            <input type="number" id="inputTimePerRelocation" value="8" min="0" class="input-field">
                        </label>
                        <label class="block">
                            <span class="label-text">Costo por Hora de Viaje</span>
                            <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Costo total del vehículo de remolque (conductor, combustible, mant., etc.) por viaje de IDA.</span></div>
                            <input type="number" id="inputCostPerHourRelocation" value="25" min="0" class="input-field">
                        </label>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 text-right">
                        <span class="text-sm font-semibold text-blue-900">Total OPEX Reubicación Móvil:</span>
                        <span id="outputTotalMobileOpex" class="text-xl font-bold text-blue-800 ml-2">$0</span>
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg border border-gray-200 space-y-3">
                    <h4 class="font-semibold text-gray-700">Infraestructura del Sitio y Permisos</h4>
                    <label class="block">
                        <span class="label-text">Edificios, Ventilación y Plataformas de Concreto ($)</span>
                        <input type="number" id="inputInfrastructureCost" value="75000" min="0" class="input-field">
                        <p class="text-[0.65rem] text-gray-500 mt-1 leading-tight">
                            Este valor asume incluir componentes civiles, estructurales, mecánicos y eléctricos relevantes, así como servicios básicos requeridos (ej. cimientos, ventilación, seguridad). Los requisitos locales pueden afectar significativamente el costo. Proyectos móviles requieren menos costo de sitio.
                        </p>
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="label-text">Tarifas de Solicitud de Permisos (Pago Único)</span>
                            <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Tarifas de solicitud de permisos de calidad del aire, laboratorio y consultoría.</span></div>
                            <input type="number" id="inputPermitCapex" value="12000" min="0" class="input-field">
                        </label>
                        <div>
                            <label class="block mb-2">
                                <span class="label-text">Modelo de Terreno</span>
                                <select id="selectLandModel" class="input-field">
                                    <option value="lease" selected>Arrendamiento Anual (OPEX)</option>
                                    <option value="buy">Compra Directa (CAPEX)</option>
                                </select>
                            </label>
                        </div>
                        <div class="space-y-4">
                            <label class="block" id="landLeaseContainer">
                                <span class="label-text">Arrendamiento de Terreno ($/año)</span>
                                <input type="number" id="inputLandLease" value="12000" min="0" class="input-field">
                            </label>
                            <label class="block hidden" id="landPurchaseContainer">
                                <span class="label-text">Compra de Terreno (CAPEX - $)</span>
                                <input type="number" id="inputLandPurchase" value="0" min="0" class="input-field">
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="bg-green-100 p-4 rounded-lg border-2 border-green-300 text-right">
                    <span class="text-lg font-semibold text-green-900 flex justify-end items-center">
                        <div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Suma de todos los ítems de CAPEX anteriores.</span></div>
                        <span class="ml-1">Total Estimado CAPEX:</span>
                    </span>
                    <span id="outputTotalCapex" class="text-3xl font-bold text-green-700">$0</span>
                </div>
            </div>
        </div>

        <div class="input-section">
            <h2 class="section-title section-title-blue">Certificación y MRV</h2>
            <div class="mb-6 bg-white p-4 rounded-lg border-2 border-blue-300">
                <label class="block">
                    <span class="label-text font-bold text-blue-900 text-base">Fuente de su estimación de costos para Certificación y MRV</span>
                    <select id="selectCertSource" class="input-field font-medium text-gray-900 mt-2">
                        <option value="" disabled selected>Elija una base de costos</option>
                        <option value="estimate">Estimación de la calculadora</option>
                        <option value="quote">Cotización del proveedor</option>
                    </select>
                </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-3">
                    <h4 class="font-bold text-blue-900 border-b border-blue-200 pb-2">Parte A: Registro</h4>
                    <label class="block">
                        <span class="label-text">Seleccionar Registro</span>
                        <select id="selectRegistry" class="input-field">
                            <option value="" disabled selected>-- Seleccionar Registro --</option>
                            <option value="puro">Puro.earth</option>
                            <option value="csi">CSI (Artisan C-Sink)</option>
                            <option value="other">Otro / Personalizado</option>
                        </select>
                    </label>
                    <label class="block">
                        <div class="flex justify-between items-center"><span class="label-text">Tarifas Estimadas ($/año)</span><div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Calculado en base a su volumen de CORC y número de centros.</span></div></div>
                        <input type="number" id="outputRegistryCost" value="0" min="0" class="input-field">
                    </label>
                    <p id="registryWarning" class="hidden text-sm text-red-600 mt-2"></p>
                </div>
                <div class="space-y-3">
                    <h4 class="font-bold text-blue-900 border-b border-blue-200 pb-2">Parte B: Socio MRV</h4>
                    <label class="block">
                        <span class="label-text">Seleccionar Socio MRV</span>
                        <select id="selectMRVPartner" class="input-field">
                            <option value="" disabled selected>-- Seleccionar Socio --</option>
                            <option value="planboo">Planboo</option>
                            <option value="custom">Personalizado / Otro</option>
                        </select>
                    </label>
                    
                    <div id="mrvWarning" class="hidden p-2 mb-2 bg-red-100 border border-red-300 text-red-800 text-xs font-bold rounded">
                        Advertencia: Su volumen es muy bajo (<1000t). Este socio podría rechazarlo.
                    </div>
                    
                    <div id="planbooInfo" class="hidden p-3 mb-2 bg-blue-100 border border-blue-300 text-blue-800 text-sm font-medium rounded">
                        Nota: La tarifa de Planboo incluye el costo de una evaluación completa del ciclo de vida (ACV).
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <label class="block"><div class="flex justify-between items-center"><span class="label-text text-xs font-semibold text-blue-800">Configuración (CAPEX $)</span><div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Tarifa fija de configuración</span></div></div>
                        <input type="number" id="outputMRVSetup" value="0" class="input-field font-semibold" min="0">
                        </label>
                        <label class="block"><div class="flex justify-between items-center"><span class="label-text text-xs font-semibold text-blue-800">Anual (OPEX $)</span><div class="tooltip-container"><span class="f-icon">f</span><span class="tooltip-text">Créditos × Tarifa por crédito</span></div></div>
                        <input type="number" id="outputMRVAnnual" value="0" class="input-field font-semibold" min="0">
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="lcaCostContainer" class="hidden mt-6 pt-4 border-t border-blue-200">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <label class="block">
                        <span class="label-text font-bold text-blue-800">Costo Único de ACV (CAPEX $)</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Costo de contratar un consultor externo para su Evaluación de Ciclo de Vida (ACV), a menudo requerido para certificación.</span></div>
                        <input type="number" id="inputLcaCost" value="5000" min="0" class="input-field border-2 border-blue-300">
                    </label>
                    <label class="block">
                        <span class="label-text font-bold text-blue-800">Renovación Anual ACV (OPEX $)</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Costo de actualizar los datos de ACV con una nueva auditoría.</span></div>
                        <input type="number" id="inputLcaAnnualCost" value="2000" min="0" class="input-field border-2 border-blue-300">
                    </label>
                 </div>
            </div>
        </div>

        <div class="input-section mb-8"> <h2 class="section-title section-title-gray">Gastos Operativos (OPEX Anual)</h2>
            
            <div id="seasonalOpsContainer" class="hidden mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <label class="block">
                    <span class="label-text font-bold text-yellow-900">Meses de Operación por Año</span>
                    <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Seleccionó "Cerrar" en Herramienta 1. Los costos de mano de obra y servicios se prorratearán según este número.</span></div>
                    <input type="number" id="inputMonthsOperational" value="3" min="1" max="12" class="input-field border-yellow-300 w-24">
                </label>
            </div>

            <div id="storeProcessNote" class="hidden mb-6 p-3 bg-orange-50 border-l-4 border-orange-400 text-sm text-orange-800 italic">
                Nota: Está almacenando materia prima. Asegúrese de que sus estimaciones de mano de obra y servicios a continuación cubran el trabajo extra de re-manejo y re-secado del material.
            </div>

            <div class="space-y-6">
                    <div class="p-4 bg-white rounded-lg border border-gray-200 shadow-sm space-y-3">
                        <h4 class="font-semibold text-gray-700">Gastos Laborales</h4>
                        <p class="text-xs text-gray-500 italic mb-2">Ingrese salarios anuales para todo el personal a tiempo completo o estacional. Esto incluye conductores, operadores, mantenimiento, gerencia y mano de obra del sitio.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block label-text">Cantidad Personal General</label>
                                    <input type="number" id="inputGeneralStaff" value="0" min="0" class="input-field">
                                </div>
                                <div>
                                    <label class="block label-text">Salario Prom. (General) ($/año)</label>
                                    <input type="number" id="inputGeneralSalary" value="0" min="0" class="input-field">
                                </div>
                                <div>
                                    <label class="block label-text">Cantidad Personal Gerencial</label>
                                    <input type="number" id="inputManagementStaff" value="0" min="0" class="input-field">
                                </div>
                                <div>
                                    <label class="block label-text">Salario Prom. (Gerencia) ($/año)</label>
                                    <input type="number" id="inputManagementSalary" value="0" min="0" class="input-field">
                                </div>
                        </div>
                    </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="block"><span class="label-text">Seguros ($/año)</span><div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Típicamente 1-2% del CAPEX total.</span></div><input type="number" id="inputInsurance" value="5000" min="0" class="input-field"></label>
                    <label class="block"><span class="label-text">Servicios Públicos ($/año)</span><div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Electricidad, agua y combustible para secadora.</span></div><input type="number" id="inputUtilities" value="8000" min="0" class="input-field"></label>
                    <label class="block"><span class="label-text">Cumplimiento Calidad Aire ($/año)</span><div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Pruebas anuales e informes.</span></div><input type="number" id="inputRegulatory" value="8000" min="0" class="input-field"></label>
                </div>
            </div>
        </div>

        <div class="input-section"> 
            <h2 class="section-title section-title-green">Supuestos Financieros</h2>
            
            <div class="mb-6 p-4 bg-white rounded-lg border border-green-200">
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="checkForwardContract" class="h-5 w-5 rounded text-green-600 focus:ring-green-500">
                    <span class="font-bold text-green-900">¿Ha asegurado un Acuerdo de Compra Futura (preventa de créditos)?</span>
                </label>
                <div id="forwardContractDetails" class="hidden mt-4 pl-4 border-l-2 border-green-300 space-y-4">
                    <label class="block">
                        <span class="label-text font-semibold text-green-800">Pago Anticipado en Efectivo ($)</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Efectivo recibido antes de la entrega. A menudo usado para cubrir pagos iniciales de equipos o costos operativos del Año 1.</span></div>
                        <input type="number" id="inputPrepayment" value="0" min="0" class="input-field border-green-300">
                    </label>
                    <p class="text-sm text-green-700 italic">Consejo: Un contrato futuro a menudo puede asegurar una tasa de interés más baja de su banco.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <label class="block">
                    <span class="label-text">Monto del Préstamo ($)</span>
                    <input type="number" id="inputLoanAmount" value="0" min="0" class="input-field">
                </label>
                <label class="block">
                    <span class="label-text">Tasa de Interés del Préstamo (%)</span>
                    <input type="number" id="inputInterestRate" value="12" min="0" class="input-field">
                </label>
                <label class="block">
                    <span class="label-text">Tasa de Impuesto Corporativo (%)</span>
                    <input type="number" id="inputTaxRate" value="30" min="0" class="input-field">
                </label>
                <label class="block">
                    <span class="label-text">Incentivos Fiscales Anuales ($)</span>
                    <input type="number" id="inputIncentives" value="0" min="0" class="input-field">
                </label>
                <label class="block">
                    <span class="label-text">Tasa de Descuento para VPN (%)</span>
                    <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Usado para Valor Presente Neto (VPN). Es su tasa mínima de retorno esperada, considerando el riesgo.</span></div>
                    <input type="number" id="inputDiscountRate" value="10" min="0" class="input-field">
                </label>
                <label class="block">
                    <span class="label-text">Vida Útil del Proyecto (Años)</span>
                    <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">El número de años para modelar sus proyecciones financieras (ej. 10 años).</span></div>
                    <input type="number" id="inputProjectLife" value="10" min="1" max="30" class="input-field">
                </label>
            </div>
        </div>

        <div class="input-section bg-gray-50 border-gray-200 p-4">
            <h3 class="font-bold text-gray-700 mb-2 uppercase text-sm tracking-wider">Notas para Investigación Futura</h3>
            <textarea id="toolNotes" rows="3" class="input-field bg-white" placeholder="Escriba aquí..."></textarea>
        </div>

        <div class="mt-8 mb-12 flex flex-col space-y-4">
            <button id="saveToDbButton" class="nav-button nav-button-indigo w-full">Guardar Datos Financieros</button>
            <div id="unsavedWarning" class="text-red-600 font-medium text-center hidden">Tienes cambios sin guardar.</div>
            
            <div id="navigationButtons" class="nav-grid hidden">
                <button onclick="navigate('tool4_es.html')" class="nav-button nav-button-blue md:col-span-1">← Volver a Herramienta 4</button>
                <button onclick="navigate('index_es.html')" class="nav-button nav-button-white md:col-span-1">Menú Principal</button>
                <button onclick="navigate('tool6_es.html')" id="nextToolButton" class="nav-button nav-button-green md:col-span-1">Ir a Panel →</button>
            </div>
            <div class="flex justify-between items-center pt-4">
                <button onclick="resetForm()" class="text-sm text-red-500 hover:text-red-700 font-medium">Reiniciar Formulario</button>
                <div id="saveStatus" class="font-medium text-red-600" style="display: none;"></div>
            </div>
        </div>
    </div>

    <footer class="disclaimer">
        <p><strong>Sin Garantía:</strong> <em>Las proyecciones proporcionadas por esta calculadora se basan en las suposiciones y datos ingresados por el usuario. Son solo para fines ilustrativos y no constituyen una garantía de costos reales, ingresos o rentabilidad.</em></p>
        <p><strong>No es Asesoramiento Financiero:</strong> <em>La información proporcionada no pretende sustituir el asesoramiento profesional financiero, legal o agrícola. Los usuarios son los únicos responsables de las decisiones tomadas en base a los resultados de esta herramienta.</em></p>
        <p><strong>Verificar Todos los Datos:</strong> <em>Los usuarios deben verificar independientemente todos los costos locales, precios de mercado y requisitos regulatorios antes de realizar cualquier inversión.</em></p>
    </footer>
<script>
        let projectData = {};
        let projectState = { scale: 'micro', type: 'centralized', hubs: 1, country: 'custom', totalCredits: 0, totalFeedstock: 0 };
        let hasUnsavedChanges = false;

        let saveButton, navigationButtons, saveStatus, unsavedWarning;

        // *** UPDATED COUNTRY DATA MATRIX ***
        const COUNTRY_DATA = {
            "bolivia": { general: 5500, management: 20000, tax: 25, interest: 12, permit: { micro: 150, small: 150, medium: 500, large: 1500 } },
            "brazil": { general: 6500, management: 28000, tax: 34, interest: 26, permit: { micro: 1000, small: 1000, medium: 2000, large: 3500 } },
            "colombia": { general: 5000, management: 21000, tax: 35, interest: 18, permit: { micro: 1000, small: 1000, medium: 1500, large: 2000 } },
            "costa_rica": { general: 7000, management: 25000, tax: 30, interest: 14, permit: { micro: 500, small: 500, medium: 1500, large: 3000 } },
            "dominican_republic": { general: 7500, management: 26000, tax: 27, interest: 15, permit: { micro: 150, small: 150, medium: 300, large: 900 } },
            "ecuador": { general: 9500, management: 24000, tax: 25, interest: 13, permit: { micro: 200, small: 200, medium: 500, large: 1500 } },
            "el_salvador": { general: 5000, management: 19000, tax: 30, interest: 12, permit: { micro: 100, small: 100, medium: 300, large: 1000 } },
            "guatemala": { general: 5500, management: 20000, tax: 25, interest: 13, permit: { micro: 100, small: 100, medium: 500, large: 1500 } },
            "honduras": { general: 4800, management: 19000, tax: 25, interest: 17, permit: { micro: 300, small: 300, medium: 1000, large: 2000 } },
            "mexico": { general: 7500, management: 26000, tax: 30, interest: 16, permit: { micro: 150, small: 150, medium: 300, large: 900 } },
            "nicaragua": { general: 4500, management: 18000, tax: 30, interest: 16, permit: { micro: 100, small: 100, medium: 300, large: 1000 } },
            "panama": { general: 14000, management: 35000, tax: 25, interest: 9, permit: { micro: 500, small: 500, medium: 1500, large: 3000 } },
            "peru": { general: 6000, management: 22000, tax: 29.5, interest: 14, permit: { micro: 150, small: 150, medium: 500, large: 1500 } },
            "custom": { general: 5000, management: 20000, tax: 25, interest: 10, permit: { micro: 200, small: 200, medium: 500, large: 1000 } }
        };

        const LABOR_MATRIX = { "micro": { general: 1, management: 0 }, "small": { general: 3, management: 1 }, "medium": { general: 6, management: 2 }, "large": { general: 15, management: 4 }};
        
        // *** Puro & CSI Fee Matrices ***
        const PURO_CONVERSION_RATE = 1.10;
        const PURO_FEES_EUR = {
            1000: 13200,  // <= 1000
            1999: 15992,  // 1001-1999
            2999: 23992,  // 2000-2999
            3999: 31992,  // 3000-3999
            99999: 36000 // 4000+
        };
        const PURO_PER_HUB_FEE = 2160; // ~$2000 EUR

        const CSI_FEES = {
            micro: { base: 648, perCredit: 3.70 },
            small: { base: 648, perCredit: 3.70 },
            medium: { base: 1500, perCredit: 3.70 },
            large: { base: 1500, perCredit: 3.70 }
        };
        const CSI_PER_HUB_FEE = 220; // ~$200 EUR
        
        const inputsToTrack = [
            'inputFeedstockLoanAmount', 'checkFeedstockLoan', 'inputFeedstockInterest',
            'inputWoodChipperCost', 'inputStorageInfra', 'inputDryerCost', 'checkSyngasDucting',
            'inputAncillaryCost', 'inputNumLogisticsTrucks', 'inputLogisticsTruckCost', 'inputNumPickups', 'inputPickupCost', 
            'inputInfrastructureCost', 'inputPermitCapex', 'selectLandModel', 'inputLandLease', 'inputLandPurchase',
            'selectCertSource', 'selectRegistry', 'outputRegistryCost', 'selectMRVPartner',
            'outputMRVSetup', 'outputMRVAnnual', 'inputLcaCost', 'inputLcaAnnualCost', 'inputMonthsOperational', 
            'inputRelocationsPerKiln', 'inputTimePerRelocation', 'inputCostPerHourRelocation', 'inputPickupsOpex',
            'inputGeneralStaff', 'inputGeneralSalary', 'inputManagementStaff', 'inputManagementSalary', 
            'inputInsurance', 'inputUtilities', 'inputRegulatory', 'checkForwardContract', 'inputPrepayment',
            'inputLoanAmount', 'inputInterestRate', 'inputTaxRate', 'inputIncentives',
            'inputDiscountRate', 'inputProjectLife', 'toolNotes'
        ];

        window.addEventListener("beforeunload", e => {
            if(hasUnsavedChanges){ e.preventDefault(); e.returnValue=""; }
        });

        function setUnsaved() {
            hasUnsavedChanges = true;
            if (saveButton) {
                saveButton.classList.remove("hidden");
                saveButton.disabled = false;
            }
            if (navigationButtons) navigationButtons.classList.add("hidden");
            if (unsavedWarning) unsavedWarning.classList.remove("hidden");
            if (saveStatus) saveStatus.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            saveButton = document.getElementById('saveToDbButton');
            navigationButtons = document.getElementById('navigationButtons');
            saveStatus = document.getElementById('saveStatus');
            unsavedWarning = document.getElementById('unsavedWarning');

            if (window.BiocharEngine) {
                projectData = BiocharEngine.loadProjectData() || {};
            } else {
                const storedData = localStorage.getItem('biocharProjectData');
                if (storedData) projectData = JSON.parse(storedData);
            }
            
            if (projectData && projectData.tool1 && projectData.tool2) {
                loadProject();
            } else {
                showError("Faltan datos de Herramienta 1 o 2. Por favor complete los pasos anteriores.");
            }

            // Attach listeners
            inputsToTrack.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const eventType = (el.tagName === 'SELECT' || el.type === 'checkbox') ? 'change' : 'input';
                    el.addEventListener(eventType, setUnsaved); // Track changes
                    
                    if(id === 'selectLandModel') el.addEventListener('change', toggleLandInputs);
                    else if(id === 'checkForwardContract') el.addEventListener('change', toggleForwardContract);
                    else if(id === 'checkFeedstockLoan') el.addEventListener('change', toggleFeedstockLoan);
                    else if(id === 'selectRegistry') el.addEventListener('change', handleRegistryChange);
                    else if(id === 'selectMRVPartner') el.addEventListener('change', handleMRVChange);
                    else if(id === 'inputRelocationsPerKiln' || id === 'inputTimePerRelocation' || id === 'inputCostPerHourRelocation') {
                        el.addEventListener('input', calculateMobileOpex); 
                    }
                    else if(id.startsWith('input') || id.startsWith('select') || id.startsWith('output') || id.startsWith('check')) {
                        el.addEventListener(eventType, calculateCapex); 
                    }
                }
            });
            
            saveButton.addEventListener('click', saveProject);
        });

        // *** NEW: Puro & CSI Logic ***
        function handleRegistryChange() {
            const regKey = document.getElementById('selectRegistry').value;
            const regOutput = document.getElementById('outputRegistryCost');
            const totalCredits = projectState.totalCredits;
            const hubs = projectState.hubs;
            
            if (regKey === 'other') {
                // User will enter custom value
            } else if (regKey === 'puro') {
                let baseFee = 0;
                // Find the correct tier
                const tierKey = Object.keys(PURO_FEES_EUR).find(key => totalCredits <= key) || 99999;
                baseFee = (PURO_FEES_EUR[tierKey] || 36000) * PURO_CONVERSION_RATE;
                
                const hubFee = (hubs > 1 && projectState.type !== 'centralized') ? (hubs - 1) * PURO_PER_HUB_FEE : 0;
                regOutput.value = (baseFee + hubFee).toFixed(0);

            } else if (regKey === 'csi') {
                const scale = projectState.scale;
                const feeData = CSI_FEES[scale] || CSI_FEES['micro'];
                const baseFee = feeData.base;
                const creditFee = totalCredits * feeData.perCredit;
                const hubFee = (hubs > 1 && projectState.type !== 'centralized') ? (hubs - 1) * CSI_PER_HUB_FEE : 0;
                regOutput.value = (baseFee + creditFee + hubFee).toFixed(0);
            }
            calculateCapex();
        }

        // *** NEW: Updated MRV Logic (Carbonfuture removed + LCA) ***
        function handleMRVChange() {
            const partner = document.getElementById('selectMRVPartner').value;
            const setup = document.getElementById('outputMRVSetup');
            const annual = document.getElementById('outputMRVAnnual');
            const warning = document.getElementById('mrvWarning');
            const lcaContainer = document.getElementById('lcaCostContainer');
            const planbooInfo = document.getElementById('planbooInfo');
            
            warning.classList.add('hidden');
            lcaContainer.classList.add('hidden');
            planbooInfo.classList.add('hidden');

            if (partner === 'custom') {
                 lcaContainer.classList.remove('hidden'); // Custom partners need LCA
            } else {
                if (partner === 'planboo') {
                    setup.value = 20000;
                    annual.value = (projectState.totalCredits * 8).toFixed(0);
                    
                    if (projectState.totalCredits < 1000 && projectState.totalCredits > 0) {
                        warning.textContent = "Volumen muy bajo. Planboo típicamente requiere 1,000+ créditos/año.";
                        warning.classList.remove('hidden');
                    } else {
                        planbooInfo.classList.remove('hidden'); // Show LCA info
                    }
                } else {
                    setup.value = 0; annual.value = 0;
                }
            }
            calculateCapex(); // Recalculate to include/exclude LCA cost
        }

        function loadProject() {
            try {
                // --- Load Project State from T1, T2, T3 ---
                const t1 = projectData.tool1;
                const t2 = projectData.tool2;
                const t3 = projectData.tool3 || {}; 

                projectState.totalFeedstock = (t2.diversified.f1_tonnes || 0) + (t2.diversified.f2_tonnes || 0);
                projectState.scale = getProjectSize(projectState.totalFeedstock / (t1.numHubs || 1));
                projectState.country = t1.country || 'custom';
                projectState.hubs = t1.numHubs || 1;
                projectState.type = t1.projectType || 'centralized';
                
                const credits1 = (t2.diversified.f1_tonnes || 0) * (1 - (t2.diversified.f1_ash || 0)) * (t2.diversified.f1_yield || 0) * (t2.diversified.f1_carbon || 0) * (t2.diversified.f1_conv || 0);
                const credits2 = (t2.diversified.f2_tonnes || 0) * (1 - (t2.diversified.f2_ash || 0)) * (t2.diversified.f2_yield || 0) * (t2.diversified.f2_carbon || 0) * (t2.diversified.f2_conv || 0);
                projectState.totalCredits = credits1 + credits2;
                
                projectState.needsChipper = t2.diversified.f2_isWood || false;
                projectState.strategy = t1.seasonalityStrategy || 'year_round';

                // Display Project State
                document.getElementById('displayScale').textContent = `${projectState.scale.toUpperCase()} (${projectState.totalFeedstock.toLocaleString()}t/año)`;
                document.getElementById('displayCountry').textContent = projectState.country.toUpperCase();
                document.getElementById('displayProjectType').textContent = projectState.type.charAt(0).toUpperCase() + projectState.type.slice(1);
                document.getElementById('displayHubs').textContent = projectState.hubs;

                // --- Handle Conditional UI ---
                if (projectState.strategy === 'store') {
                    document.getElementById('storageInfraContainer').classList.remove('hidden');
                    document.getElementById('storeProcessNote').classList.remove('hidden');
                }
                if (projectState.strategy === 'shutdown') {
                    document.getElementById('seasonalOpsContainer').classList.remove('hidden');
                }
                if (projectState.needsChipper) {
                    document.getElementById('woodChipperContainer').classList.remove('hidden');
                }
                if (projectState.type === 'mobile') {
                    document.getElementById('mobileRelocationContainer').classList.remove('hidden');
                    document.getElementById('inputNumMobileKilns').value = t2.kiln?.number_of_kilns || 1;
                }

                // --- Auto-fill default values on FIRST load ---
                const savedData = projectData.tool5;
                if (!savedData) {
                    const f1_cost = (t2.diversified.f1_tonnes || 0) * (t2.diversified.f1_price || 0);
                    const f2_cost = (t2.diversified.f2_tonnes || 0) * (t2.diversified.f2_price || 0);
                    const logistics_cost = t3.totalAnnualLogisticsCost || 0;
                    document.getElementById('inputFeedstockLoanAmount').value = (f1_cost + f2_cost + logistics_cost).toFixed(0);

                    const kilnCapex = t2.kiln?.total_upfront_pyrolyzer_capex || 0;
                    document.getElementById('outputTotalKilnCost').value = kilnCapex.toFixed(0);
                    if (kilnCapex === 0) {
                        document.getElementById('kilnCostWarning').textContent = "No se encontró costo de horno en Herr. 2. Puede ingresar un valor manual.";
                        document.getElementById('outputTotalKilnCost').removeAttribute('readonly'); // Unlock if 0
                    }

                    updateCountryDefaults(true); 
                } else {
                    // --- Load Saved Data ---
                    document.getElementById('selectCertSource').value = savedData.certSource || '';
                    document.getElementById('checkSyngasDucting').checked = savedData.syngasDucting || false;
                    
                    document.getElementById('outputTotalKilnCost').value = savedData.capex?.totalKilns || 0;
                    document.getElementById('inputWoodChipperCost').value = savedData.capex?.woodChipper || 15000;
                    document.getElementById('inputStorageInfra').value = savedData.capex?.storageInfra || 10000;
                    document.getElementById('inputDryerCost').value = savedData.capex?.dryer || 50000;
                    document.getElementById('inputAncillaryCost').value = savedData.capex?.ancillary || 25000;
                    
                    document.getElementById('inputNumLogisticsTrucks').value = savedData.capex?.logisticsTrucks || 0;
                    document.getElementById('inputLogisticsTruckCost').value = savedData.capex?.logisticsTruckCost || 40000;
                    document.getElementById('inputNumPickups').value = savedData.capex?.pickups || 1;
                    document.getElementById('inputPickupCost').value = savedData.capex?.pickupCost || 30000;

                    document.getElementById('inputInfrastructureCost').value = savedData.capex?.infrastructure || 75000;
                    document.getElementById('inputPermitCapex').value = savedData.capex?.permitApplication || 12000;
                    document.getElementById('selectLandModel').value = savedData.capex?.landPurchase > 0 ? 'buy' : 'lease';
                    document.getElementById('inputLandPurchase').value = savedData.capex?.landPurchase || 0;
                    
                    document.getElementById('inputGeneralStaff').value = savedData.opex?.generalStaffCount || 0;
                    document.getElementById('inputGeneralSalary').value = savedData.opex?.generalSalary || 0;
                    document.getElementById('inputManagementStaff').value = savedData.opex?.mgmtStaffCount || 0;
                    document.getElementById('inputManagementSalary').value = savedData.opex?.mgmtSalary || 0;
                    document.getElementById('inputLandLease').value = savedData.opex?.landLease || 12000;
                    document.getElementById('inputInsurance').value = savedData.opex?.insurance || 5000;
                    document.getElementById('inputUtilities').value = savedData.opex?.utilities || 8000;
                    document.getElementById('inputPickupsOpex').value = savedData.opex?.pickupsAnnualOpex || 3000; 
                    document.getElementById('inputRegulatory').value = savedData.opex?.regulatory || 8000;
                    document.getElementById('inputMonthsOperational').value = savedData.opex?.monthsOperational || 12;

                    document.getElementById('inputRelocationsPerKiln').value = savedData.opex?.mobileRelocationsPerKiln || 4;
                    document.getElementById('inputTimePerRelocation').value = savedData.opex?.mobileTimePerRelocation || 8;
                    document.getElementById('inputCostPerHourRelocation').value = savedData.opex?.mobileCostPerHour || 25;

                    document.getElementById('selectRegistry').value = savedData.opex?.registryName || "";
                    document.getElementById('selectMRVPartner').value = savedData.opex?.mrvPartner || "";
                    
                    document.getElementById('outputRegistryCost').value = savedData.opex.registryFees || 0;
                    document.getElementById('outputMRVSetup').value = savedData.capex.mrvSetup || 0;
                    document.getElementById('outputMRVAnnual').value = savedData.opex.mrvAnnual || 0;
                    document.getElementById('inputLcaCost').value = savedData.capex.lcaCost || 5000;
                    document.getElementById('inputLcaAnnualCost').value = savedData.opex.lcaAnnual || 2000; 
                    
                    document.getElementById('checkForwardContract').checked = savedData.finance?.forwardContract || false;
                    document.getElementById('inputPrepayment').value = savedData.finance?.prepayment || 0;
                    document.getElementById('inputFeedstockLoanAmount').value = savedData.opex?.feedstockWorkingCapital || 0;
                    document.getElementById('checkFeedstockLoan').checked = savedData.opex?.hasFeedstockLoan || false;
                    document.getElementById('inputFeedstockInterest').value = savedData.opex?.feedstockLoanInterestRate || 15;

                    document.getElementById('inputLoanAmount').value = savedData.finance?.loanAmount || 0;
                    document.getElementById('inputInterestRate').value = savedData.finance?.interestRate || 12;
                    document.getElementById('inputTaxRate').value = savedData.finance?.taxRate || 30;
                    document.getElementById('inputIncentives').value = savedData.finance?.incentives || 0;
                    document.getElementById('inputDiscountRate').value = savedData.finance?.discountRate || 10;
                    document.getElementById('inputProjectLife').value = savedData.finance?.projectLife || 10;

                    if (projectData.notes_T5) document.getElementById('toolNotes').value = projectData.notes_T5;
                    
                    saveButton.classList.add('hidden');
                    navigationButtons.classList.remove('hidden');
                }
                
                toggleLandInputs(false); 
                toggleForwardContract();
                toggleFeedstockLoan();
                
                handleRegistryChange(); 
                handleMRVChange(); 
                calculateMobileOpex(); 
                calculateCapex(); 

                saveButton.disabled = true;
                unsavedWarning.classList.add('hidden');

            } catch (e) { console.error(e); showError("Error cargando datos."); }
        }

        function saveProject() {
            saveButton.textContent = "Guardando...";
            saveButton.disabled = true;
            saveStatus.style.display = 'none';
            
            const dataToSave = {
                certSource: document.getElementById('selectCertSource').value,
                syngasDucting: document.getElementById('checkSyngasDucting').checked,
                capex: {
                    totalKilns: parseFloat(document.getElementById('outputTotalKilnCost').value.replace(/[^0-9.]/g, '')) || 0,
                    woodChipper: parseFloat(document.getElementById('inputWoodChipperCost')?.value) || 0,
                    storageInfra: parseFloat(document.getElementById('inputStorageInfra')?.value) || 0,
                    dryer: parseFloat(document.getElementById('inputDryerCost').value) || 0,
                    ancillary: parseFloat(document.getElementById('inputAncillaryCost').value) || 0,
                    logisticsTrucks: parseInt(document.getElementById('inputNumLogisticsTrucks').value) || 0,
                    logisticsTruckCost: parseFloat(document.getElementById('inputLogisticsTruckCost').value) || 0,
                    pickups: parseInt(document.getElementById('inputNumPickups').value) || 0,
                    pickupCost: parseFloat(document.getElementById('inputPickupCost').value) || 0,
                    infrastructure: parseFloat(document.getElementById('inputInfrastructureCost').value) || 0,
                    permitApplication: parseFloat(document.getElementById('inputPermitCapex').value) || 0,
                    landPurchase: parseFloat(document.getElementById('inputLandPurchase').value) || 0,
                    mrvSetup: parseFloat(document.getElementById('outputMRVSetup').value) || 0,
                    lcaCost: parseFloat(document.getElementById('inputLcaCost').value) || 0,
                    syngasCost: parseFloat(document.getElementById('outputSyngasCost').textContent.replace(/[^0-9.]/g, '')) || 0,
                    totalCapex: parseFloat(document.getElementById('outputTotalCapex').textContent.replace(/[^0-9.]/g, '')) || 0
                },
                opex: {
                    generalStaffCount: parseFloat(document.getElementById('inputGeneralStaff').value) || 0,
                    generalSalary: parseFloat(document.getElementById('inputGeneralSalary').value) || 0,
                    mgmtStaffCount: parseFloat(document.getElementById('inputManagementStaff').value) || 0,
                    mgmtSalary: parseFloat(document.getElementById('inputManagementSalary').value) || 0,
                    landLease: parseFloat(document.getElementById('inputLandLease').value) || 0,
                    insurance: parseFloat(document.getElementById('inputInsurance').value) || 0,
                    utilities: parseFloat(document.getElementById('inputUtilities').value) || 0,
                    pickupsAnnualOpex: parseFloat(document.getElementById('inputPickupsOpex').value) || 0, 
                    regulatory: parseFloat(document.getElementById('inputRegulatory').value) || 0,
                    registryName: document.getElementById('selectRegistry').value,
                    registryFees: parseFloat(document.getElementById('outputRegistryCost').value) || 0,
                    mrvPartner: document.getElementById('selectMRVPartner').value,
                    mrvAnnual: parseFloat(document.getElementById('outputMRVAnnual').value) || 0,
                    lcaAnnual: parseFloat(document.getElementById('inputLcaAnnualCost').value) || 0, 
                    monthsOperational: parseFloat(document.getElementById('inputMonthsOperational').value) || 12,
                    feedstockWorkingCapital: parseFloat(document.getElementById('inputFeedstockLoanAmount').value) || 0,
                    feedstockLoanInterestRate: parseFloat(document.getElementById('inputFeedstockInterest')?.value) || 0,
                    hasFeedstockLoan: document.getElementById('checkFeedstockLoan').checked,
                    mobileRelocationsPerKiln: parseFloat(document.getElementById('inputRelocationsPerKiln').value) || 0,
                    mobileTimePerRelocation: parseFloat(document.getElementById('inputTimePerRelocation').value) || 0,
                    mobileCostPerHour: parseFloat(document.getElementById('inputCostPerHourRelocation').value) || 0,
                    totalMobileRelocationOpex: parseFloat(document.getElementById('outputTotalMobileOpex').textContent.replace(/[^0-9.]/g, '')) || 0
                },
                finance: {
                    loanAmount: parseFloat(document.getElementById('inputLoanAmount').value) || 0,
                    interestRate: parseFloat(document.getElementById('inputInterestRate').value) || 0,
                    taxRate: parseFloat(document.getElementById('inputTaxRate').value) || 0,
                    incentives: parseFloat(document.getElementById('inputIncentives').value) || 0,
                    discountRate: parseFloat(document.getElementById('inputDiscountRate').value) || 0,
                    projectLife: parseFloat(document.getElementById('inputProjectLife').value) || 10,
                    forwardContract: document.getElementById('checkForwardContract').checked,
                    prepayment: parseFloat(document.getElementById('inputPrepayment').value) || 0
                },
                lastUpdated: new Date().toISOString()
            };

            try {
                projectData.tool5 = dataToSave;
                projectData.notes_T5 = document.getElementById('toolNotes').value;
                
                if (window.BiocharEngine) {
                    BiocharEngine.saveProjectData(projectData);
                } else {
                    localStorage.setItem('biocharProjectData', JSON.stringify(projectData));
                }
                
                saveStatus.textContent = "Datos Guardados!";
                saveStatus.style.display = 'block';
                saveStatus.style.color = 'rgb(22 163 74)'; 
                
                hasUnsavedChanges = false;
                unsavedWarning.classList.add('hidden');
                saveButton.classList.add('hidden');
                navigationButtons.classList.remove('hidden');
            } catch (e) { showError("Error al guardar."); saveButton.disabled = false; }
        }

        // --- UI HELPER FUNCTIONS ---
        function toggleLandInputs(runCalc = true) {
            const model = document.getElementById('selectLandModel').value;
            if(model === 'lease') {
                    document.getElementById('landPurchaseContainer').classList.add('hidden');
                    document.getElementById('landLeaseContainer').classList.remove('hidden');
                    document.getElementById('inputLandPurchase').value = 0; // Clear value
            } else {
                    document.getElementById('landLeaseContainer').classList.add('hidden');
                    document.getElementById('landPurchaseContainer').classList.remove('hidden');
                    document.getElementById('inputLandLease').value = 0; // Clear value
            }
            if (runCalc) calculateCapex();
        }
        
        function toggleForwardContract() {
            const checked = document.getElementById('checkForwardContract').checked;
            const details = document.getElementById('forwardContractDetails');
            if(checked) details.classList.remove('hidden');
            else details.classList.add('hidden');
        }

        function toggleFeedstockLoan() {
            const checked = document.getElementById('checkFeedstockLoan').checked;
            const details = document.getElementById('feedstockLoanDetails');
            if(checked) details.classList.remove('hidden');
            else details.classList.add('hidden');
        }

        function updateCountryDefaults(isNewProject) {
            const country = projectState.country;
            const scale = projectState.scale;
            if (isNewProject) {
                const data = COUNTRY_DATA[country] || COUNTRY_DATA['custom'];
                const labor = LABOR_MATRIX[scale] || LABOR_MATRIX['micro'];
                if (labor) {
                    document.getElementById('inputGeneralStaff').value = labor.general;
                    document.getElementById('inputManagementStaff').value = labor.management;
                }
                if (data) {
                    document.getElementById('inputGeneralSalary').value = data.general;
                    document.getElementById('inputManagementSalary').value = data.management;
                    document.getElementById('inputTaxRate').value = data.tax;
                    document.getElementById('inputInterestRate').value = data.interest;
                    
                    if (typeof data.permit === 'object') {
                        document.getElementById('inputPermitCapex').value = data.permit[scale] || data.permit['micro'];
                    } else {
                        document.getElementById('inputPermitCapex').value = data.permit || 8000;
                    }
                }
                if (projectState.type === 'mobile') {
                    document.getElementById('inputInfrastructureCost').value = 5000;
                    document.getElementById('inputLandLease').value = 0;
                }
            }
        }

        function calculateMobileOpex() {
            const getNum = (id) => parseFloat(document.getElementById(id)?.value) || 0;
            const numKilns = getNum('inputNumMobileKilns');
            const relocations = getNum('inputRelocationsPerKiln');
            const time = getNum('inputTimePerRelocation');
            const cost = getNum('inputCostPerHourRelocation');
            
            const totalOpex = numKilns * relocations * time * cost;
            
            const outputEl = document.getElementById('outputTotalMobileOpex');
            outputEl.textContent = `$${totalOpex.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        }

        function calculateCapex() {
            let total = 0;
            const getNum = (id) => parseFloat(document.getElementById(id)?.value) || 0;

            const kilnTotal = getNum('outputTotalKilnCost');
            total += kilnTotal;
            
            if (projectState.needsChipper) total += getNum('inputWoodChipperCost');
            if (projectState.strategy === 'store') total += getNum('inputStorageInfra');
            
            total += getNum('inputDryerCost');
            total += getNum('inputAncillaryCost');
            
            const numLogisticsTrucks = getNum('inputNumLogisticsTrucks');
            const logisticsTruckCost = getNum('inputLogisticsTruckCost');
            total += (numLogisticsTrucks * logisticsTruckCost);
            
            const numPickups = getNum('inputNumPickups'); 
            const pickupCost = getNum('inputPickupCost'); 
            total += (numPickups * pickupCost);
            
            total += getNum('inputInfrastructureCost');
            total += getNum('inputPermitCapex');
            total += getNum('outputMRVSetup');

            if (!document.getElementById('lcaCostContainer').classList.contains('hidden')) {
                total += getNum('inputLcaCost');
            }
            
            if (document.getElementById('selectLandModel').value === 'buy') {
                total += getNum('inputLandPurchase');
            }
            
            let syngas = 0;
            if (document.getElementById('checkSyngasDucting').checked) {
                syngas = kilnTotal * 0.10;
            }
            document.getElementById('outputSyngasCost').textContent = `$${syngas.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            total += syngas;

            document.getElementById('outputTotalCapex').textContent = `$${total.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        }
        
        function getProjectSize(volumePerHub) {
            if (volumePerHub < 100) return 'n/a';
            if (volumePerHub >= 100 && volumePerHub < 400) return 'micro';
            if (volumePerHub >= 400 && volumePerHub < 1300) return 'small';
            if (volumePerHub >= 1300 && volumePerHub < 6000) return 'medium';
            if (volumePerHub >= 6000) return 'large';
            return 'n/a';
        }
        
        function showError(msg) { 
            if(saveStatus) {
                saveStatus.textContent = msg;
                saveStatus.style.display = 'block';
                saveStatus.style.color = 'rgb(220 38 38)'; 
            }
        }
        
        window.navigate = function(url) {
            if (hasUnsavedChanges) {
                alert("Tienes cambios sin guardar. Haz clic en 'Guardar' antes de continuar.");
            } else {
                window.location.href = url;
            }
        }

        window.resetForm = function() {
            if (!confirm("Esto borrará TODOS los datos del proyecto. ¿Estás seguro?")) return;

            projectData = {}; 

            if (window.BiocharEngine && BiocharEngine.clearProjectData) {
                BiocharEngine.clearProjectData();
            } else {
                localStorage.removeItem("biocharProjectData");
                localStorage.removeItem("currentProjectId");
            }

            location.reload();
        }
    </script>
</body>
</html>