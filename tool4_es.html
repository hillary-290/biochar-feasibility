<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Ingresos de Biochar (Herramienta 4)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="engine.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f4f4f5; }
    .input-section { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6; }
    .section-green-tint { @apply bg-green-50 border-green-200; }
    .section-title { @apply text-xl font-bold pb-2 border-b mb-4; }
    .section-title-green { @apply text-green-800 border-green-300; }
    .section-title-blue { @apply text-blue-900 border-blue-200; }
    .section-title-gray { @apply text-gray-800 border-gray-300; }
    .label-text { @apply block text-sm font-medium text-gray-700 mb-1; }
    .input-field { @apply mt-1 block w-full rounded-md border-gray-400 shadow-sm p-3 bg-white focus:border-green-500 focus:ring-green-500 transition duration-150; }
    .input-field[readonly] { @apply bg-gray-100 text-gray-500 cursor-not-allowed; }
    .tooltip-container { position: relative; display: inline-flex; align-items: center; cursor: help; vertical-align: middle; }
    .tooltip-icon { width: 16px; height: 16px; background-color: #9ca3af; color: white; font-size: 10px; font-weight: bold; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 6px; }
    .f-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #6b7280; color: white; border-radius: 50%; font-family: 'Georgia', serif; font-style: italic; font-weight: bold; font-size: 14px; line-height: 1; padding-bottom: 2px; margin-right: 6px; }
    .tooltip-text { position: absolute; width: 240px; background-color: #374151; color: white; font-size: 0.75rem; padding: 10px; border-radius: 6px; bottom: 150%; left: 50%; transform: translateX(-50%); visibility: hidden; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 50; font-weight: normal; text-align: left; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    .hidden { display: none; }
    .progress-bar-container { @apply w-full bg-gray-200 rounded-full h-2.5 mb-6; }
    .progress-bar { @apply bg-green-600 h-2.5 rounded-full transition-all duration-500; }
    .disclaimer { text-align: left; font-size: 0.75rem; color: #6b7280; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; }
    .disclaimer p { margin-bottom: 0.5rem; font-style: italic; }
    .disclaimer strong { font-weight: 600; color: #4b5563; font-style: normal; }
    .nav-grid { @apply grid grid-cols-2 md:grid-cols-3 gap-3 items-center; }
    .nav-button { display: inline-block; padding: 12px 20px; font-weight: 700; border: none; border-radius: 12px; font-size: 0.875rem; cursor: pointer; transition: opacity 0.2s; text-decoration: none; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -2px rgba(0,0,0,0.1); }
    .nav-button:hover { opacity: 0.9; }
    .nav-button-blue { background-color: #2563eb; color: white; }
    .nav-button-green { background-color: #16a34a; color: white; }
    .nav-button-indigo { background-color: #4f46e5; color: white; }
    .nav-button-white { background-color: white; color: #2563eb; border: 2px solid #dbeafe; }
    .nav-button-white:hover { background-color: #f9fafb; }
</style>
</head>
<body class="p-4 md:p-8">
<div class="max-w-2xl mx-auto">
<header class="text-center mb-6">
    <h1 class="text-2xl md:text-3xl font-extrabold text-green-700">Calculadora de Viabilidad de Biochar</h1>
    <h2 class="text-lg font-medium text-gray-700 mt-1">para Cadenas de Suministro de Café y Cacao en América Latina</h2>
    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mt-4">Climatebase Fellowship Cohort 8 - Proyecto Capstone</p>
    <p class="text-xs font-medium text-gray-500 mt-2">(Todos los valores en USD)</p>
    
    <div class="mt-4 mb-6">
        <a href="https://chatgpt.com/g/g-691ea2b1c2888191b85e54e203c53b2f-biochar-feasibility-guide" 
           target="_blank" 
           class="inline-block bg-blue-50 text-blue-700 hover:text-blue-900 border border-blue-200 rounded-full px-4 py-1 text-sm font-medium transition">
            ¿Preguntas? Haz clic aquí para consultar al Asistente IA de Biochar ↗
        </a>
    </div>

    <p class="text-lg font-medium text-green-800">Herramienta 4: Flujos de Ingresos</p>
</header>

<div class="w-full mb-8">
<div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
<span>Paso 4 de 7: Ingresos</span>
<span>(Siguiente: CAPEX y OPEX)</span>
</div>
<div class="progress-bar-container">
<div class="progress-bar" style="width: 57.1%"></div>
</div>
</div>

<div class="input-section section-green-tint">
<h2 class="section-title section-title-green">Ingresos por Créditos de Carbono</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<label class="block"><span class="label-text font-semibold text-gray-800">Total Créditos Reclamables (tCO2e)</span>
<input type="number" id="inputTotalCredits" value="0" class="input-field" readonly></label>
<label class="block"><span class="label-text font-semibold text-green-800">Precio del Crédito de Carbono ($/tCO2e)</span>
<input type="number" id="inputCreditPrice" value="100" min="0" class="input-field border-2 border-green-500"></label>
</div>
<p id="loadingIndicatorCredits" class="text-xs text-yellow-700">Cargando desde Herramienta 2...</p>
</div>

<div class="input-section">
<h2 class="section-title section-title-blue">Ingresos por Ventas de Biochar</h2>

<div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 space-y-3 mb-6">
<label class="block">
<span class="label-text font-semibold text-yellow-800">Total Biochar Producido (Toneladas)</span>
<div class="flex items-center">
<input type="number" id="inputTotalBiocharTonnes" value="0" class="input-field" readonly>
<div class="tooltip-container ml-2"><span class="tooltip-icon">?</span>
<span class="tooltip-text">Suma del biochar producido en la Herramienta 2.</span></div>
</div>
<p id="loadingIndicatorBiochar" class="text-xs text-yellow-700 mt-1">Cargando desde Herramienta 2...</p>
</label>
</div>

<div class="space-y-6">
<label class="block">
<span class="label-text">Modelo de Ventas de Biochar</span>
<select id="selectBiocharModel" class="input-field" required>
<option value="" disabled selected>Seleccionar Modelo</option>
<option value="retail">Venta al por menor (Mezcla Biochar/Compost)</option>
<option value="bulk">Biochar a Granel</option>
</select>
</label>

<div id="retailFields" class="p-4 bg-white rounded-lg border border-gray-200 space-y-4" style="display: none;">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<label class="block"><span class="label-text">% Biochar en la Mezcla</span>
<input type="number" id="inputBiocharPercentInMix" value="30" min="0" max="100" class="input-field"></label>
<label class="block"><span class="label-text">Costo del Compost ($/Tonelada)</span>
<input type="number" id="inputCompostCost" value="50" min="0" class="input-field"></label>
<label class="block"><span class="label-text">Peso por Saco (kg)</span>
<input type="number" id="inputBagWeightKg" value="20" min="0" class="input-field"></label>
<label class="block"><span class="label-text font-semibold text-green-800">Precio de Venta al Público ($/saco)</span>
<input type="number" id="inputRetailPricePerBag" value="25" min="0" step="0.01" class="input-field border-2 border-green-500"></label>
<label class="block"><span class="label-text">Costo de Empaque ($/saco)</span>
<input type="number" id="inputPackagingCostPerBag" value="1.50" min="0" step="0.01" class="input-field"></label>
<label class="block"><span class="label-text">Costo de Distribución ($/saco)</span>
<input type="number" id="inputDistributionCostPerBag" value="2.00" min="0" step="0.01" class="input-field"></label>
</div>

<div class="pt-4 border-t border-gray-300 space-y-4">
<label class="block"><span class="label-text font-semibold text-blue-800">Registro Inicial de Producto y Laboratorio (CAPEX)</span>
<input type="number" id="inputInitialComplianceCost" value="0" min="0" class="input-field border-2 border-blue-300"></label>
<label class="block"><span class="label-text font-semibold text-blue-800">Cumplimiento Anual del Producto (OPEX)</span>
<input type="number" id="inputAnnualComplianceCost" value="1000" min="0" class="input-field border-2 border-blue-300"></label>
</div>
</div>

<div id="bulkFields" class="p-4 bg-white rounded-lg border border-gray-200 space-y-2" style="display: none;">
<label class="block"><span class="label-text font-semibold text-green-800">Precio de Venta de Biochar a Granel ($/Tonelada)</span>
<input type="number" id="inputBulkPrice" value="500" min="0" class="input-field border-2 border-green-500"></label>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<label class="block"><span class="label-text inline">Tasa de Ventas Esperada (%)</span>
<select id="selectSalesRate" class="input-field">
<option value="1.0">100% (Gran Acogida)</option>
<option value="0.75" selected>75% (Buena Acogida)</option>
<option value="0.5">50% (Poca Acogida)</option>
<option value="0.25">25% (Muy Poca Acogida)</option>
</select>
</label>
<label class="block"><span class="label-text inline">Plan de Marketing</span>
<select id="selectMarketingPlan" class="input-field">
<option value="" disabled selected>Seleccionar Plan</option>
<option value="coop">Cooperativa / Distribución integrada</option>
<option value="contract">Contrato de distribución regional</option>
<option value="none">Plan de marketing en proceso</option>
</select>
</label>
</div>

<label class="block"><span class="label-text">Presupuesto Anual de Ventas y Marketing ($)</span>
<input type="number" id="inputMarketingBudget" value="5000" min="0" class="input-field"></label>
</div>

<div class="input-section">
<h2 class="section-title section-title-gray">Otros Flujos de Ingresos (Opcional)</h2>
<div class="p-4 bg-white rounded-lg border border-gray-200 space-y-3">
<label class="flex items-center space-x-3 cursor-pointer">
<input type="checkbox" id="checkSellWoodVinegar" class="h-5 w-5 rounded text-green-600 focus:ring-green-500">
<span class="text-blue-900 font-semibold">¿Vender Vinagre de Madera?</span>
</label>
<div id="woodVinegarFields" class="space-y-3 transition-all duration-300" style="max-height: 0; opacity: 0; overflow: hidden;">
<div class="grid grid-cols-1 md:grid-cols-3 gap-3">
<label class="block"><span class="label-text">Precio de Venta ($/L)</span>
<input type="number" id="inputWoodVinegarPrice" value="1.00" min="0" class="input-field border-blue-300"></label>
<label class="block"><span class="label-text">Costo de Empaque ($/L)</span>
<input type="number" id="inputWoodVinegarPackaging" value="0.30" min="0" class="input-field"></label>
<label class="block"><span class="label-text">Costo de Distribución ($/L)</span>
<input type="number" id="inputWoodVinegarDistribution" value="0.05" min="0" class="input-field"></label>
</div>
</div>
</div>
</div>

<div class="input-section bg-gray-50 border-gray-200 p-4">
<h3 class="font-bold text-gray-700 mb-2 uppercase text-sm tracking-wider">Notas para Investigación Futura</h3>
<textarea id="toolNotes" rows="3" class="input-field bg-white" placeholder="Escriba aquí..."></textarea>
</div>

<div class="mt-8 mb-12 flex flex-col space-y-4">
<button id="saveToDbButton" class="nav-button nav-button-indigo w-full">Guardar Datos de Ingresos</button>
<div id="unsavedWarning" class="text-red-600 font-medium text-center hidden">Tienes cambios sin guardar.</div>
<div id="navigationButtons" class="nav-grid hidden">
<button onclick="navigate('tool3_es.html')" class="nav-button nav-button-blue md:col-span-1">← Volver a Herramienta 3</button>
<button onclick="navigate('index_es.html')" class="nav-button nav-button-white md:col-span-1">Menú Principal</button>
<button onclick="navigate('tool5_es.html')" id="nextToolButton" class="nav-button nav-button-green md:col-span-1">Ir a Herramienta 5 →</button>
</div>
<div class="flex justify-between items-center pt-4">
<button onclick="resetForm()" class="text-sm text-red-500 hover:text-red-700 font-medium">Reiniciar Formulario</button>
<div id="saveStatus" class="font-medium text-green-600" style="display: none;"></div>
</div>
</div>
</div>

<footer class="disclaimer">
<p><strong>Sin Garantía:</strong> <em>Las proyecciones proporcionadas por esta calculadora se basan en las suposiciones y datos ingresados por el usuario. Son solo para fines ilustrativos y no constituyen una garantía de costos reales, ingresos o rentabilidad.</em></p>
<p><strong>No es Asesoramiento Financiero:</strong> <em>La información proporcionada no pretende sustituir el asesoramiento profesional financiero, legal o agrícola. Los usuarios son los únicos responsables de las decisiones tomadas en base a los resultados de esta herramienta.</em></p>
<p><strong>Verificar Todos los Datos:</strong> <em>Los usuarios deben verificar independientemente todos los costos locales, precios de mercado y requisitos regulatorios antes de realizar cualquier inversión.</em></p>
</footer>

<script>
// --- GLOBAL VARIABLES ---
const saveButton = document.getElementById('saveToDbButton');
const navigationButtons = document.getElementById('navigationButtons');
const loadingIndicatorCredits = document.getElementById('loadingIndicatorCredits');
const loadingIndicatorBiochar = document.getElementById('loadingIndicatorBiochar');
const saveStatus = document.getElementById('saveStatus');
const unsavedWarning = document.getElementById('unsavedWarning');
let projectData = {};
let totalFeedstockForVinegar = 0;
let hasUnsavedChanges = false;

const inputsToTrack = [
    'inputCreditPrice','selectBiocharModel','inputBiocharPercentInMix','inputCompostCost',
    'inputBagWeightKg','inputRetailPricePerBag','inputPackagingCostPerBag','inputDistributionCostPerBag',
    'inputInitialComplianceCost','inputAnnualComplianceCost','inputBulkPrice','selectSalesRate',
    'selectMarketingPlan','inputMarketingBudget','checkSellWoodVinegar','selectWoodVinegarYield',
    'inputWoodVinegarPrice','inputWoodVinegarPackaging','inputWoodVinegarDistribution','toolNotes'
];

// --- EVENT TRACKING ---
window.addEventListener("beforeunload", e => { if(hasUnsavedChanges){ e.preventDefault(); e.returnValue=""; }});
function setUnsaved() {
    hasUnsavedChanges = true;
    saveButton.classList.remove("hidden"); 
    saveButton.disabled = false;
    navigationButtons.classList.add("hidden"); 
    unsavedWarning.classList.remove("hidden");
    saveStatus.style.display = 'none';
}

// --- DOM CONTENT LOADED ---
document.addEventListener('DOMContentLoaded', () => {
    if(window.BiocharEngine){ projectData = BiocharEngine.loadProjectData() || {}; }
    else { const stored = localStorage.getItem('biocharProjectData'); if(stored) projectData = JSON.parse(stored); }
    loadProject();

    document.getElementById('selectBiocharModel').addEventListener('change', handleBiocharModelChange);
    setupCheckboxToggle('checkSellWoodVinegar','woodVinegarFields');
    handleBiocharModelChange();
    saveButton.addEventListener('click', saveProject);

    inputsToTrack.forEach(id => {
        const el = document.getElementById(id);
        if(el){ const evt = (el.tagName==='SELECT'||el.type==='checkbox')?'change':'input'; el.addEventListener(evt,setUnsaved); }
    });
});

// --- LOAD PROJECT ---
function loadProject() {
    try {
        if(!projectData.tool2 || !projectData.tool2.diversified){ showError("Faltan datos de la Herramienta 2."); return; }
        const t2 = projectData.tool2.diversified;
        const biochar1 = (t2.f1_tonnes||0)*(1-(t2.f1_ash||0))*(t2.f1_yield||0);
        const credits1 = biochar1*(t2.f1_carbon||0)*(t2.f1_conv||0);
        const biochar2 = (t2.f2_tonnes||0)*(1-(t2.f2_ash||0))*(t2.f2_yield||0);
        const credits2 = biochar2*(t2.f2_carbon||0)*(t2.f2_conv||0);
        const totalBiochar = biochar1+biochar2;
        const totalCredits = credits1+credits2;
        totalFeedstockForVinegar = (t2.f1_tonnes||0)+(t2.f2_tonnes||0);
        document.getElementById('inputTotalBiocharTonnes').value = totalBiochar.toFixed(2);
        document.getElementById('inputTotalCredits').value = totalCredits.toFixed(2);
        loadingIndicatorCredits.textContent="Cargado desde Herramienta 2"; loadingIndicatorCredits.classList.add('text-green-600');
        loadingIndicatorBiochar.textContent="Cargado desde Herramienta 2"; loadingIndicatorBiochar.classList.add('text-green-600');

        const data = projectData.tool4;
        if(data && data.lastUpdated){
          
// --- LOAD PROJECT: Fill Tool 4 Inputs Safely ---
if (data && data.lastUpdated) {
    const creditInput = document.getElementById('inputCreditPrice');
    if (creditInput) creditInput.value = data.carbonCreditPrice || 100;

    const salesModelSelect = document.getElementById('selectBiocharModel');
    if (salesModelSelect) salesModelSelect.value = data.salesModel || "";

    const retailMixInput = document.getElementById('inputBiocharPercentInMix');
    if (retailMixInput) retailMixInput.value = data.retailMixPercent || 30;

    const compostInput = document.getElementById('inputCompostCost');
    if (compostInput) compostInput.value = data.compostCost || 50;

    const bagWeightInput = document.getElementById('inputBagWeightKg');
    if (bagWeightInput) bagWeightInput.value = data.retailBagWeightKg || 20;

    const retailPriceInput = document.getElementById('inputRetailPricePerBag');
    if (retailPriceInput) retailPriceInput.value = data.retailPricePerBag || 25;

    const packagingInput = document.getElementById('inputPackagingCostPerBag');
    if (packagingInput) packagingInput.value = data.retailPackagingCostPerBag || 1.50;

    const distributionInput = document.getElementById('inputDistributionCostPerBag');
    if (distributionInput) distributionInput.value = data.retailDistributionCostPerBag || 2.00;

    const bulkPriceInput = document.getElementById('inputBulkPrice');
    if (bulkPriceInput) bulkPriceInput.value = data.bulkPrice || 500;

    const initialComplianceInput = document.getElementById('inputInitialComplianceCost');
    if (initialComplianceInput) initialComplianceInput.value = data.soilAmendmentInitialCost || 0;

    const annualComplianceInput = document.getElementById('inputAnnualComplianceCost');
    if (annualComplianceInput) annualComplianceInput.value = data.soilAmendmentAnnualCost || 1000;

    const salesRateSelect = document.getElementById('selectSalesRate');
    if (salesRateSelect) salesRateSelect.value = data.salesRate || 0.75;

    const marketingPlanSelect = document.getElementById('selectMarketingPlan');
    if (marketingPlanSelect) marketingPlanSelect.value = data.marketingPlan || "";

    const marketingBudgetInput = document.getElementById('inputMarketingBudget');
    if (marketingBudgetInput) marketingBudgetInput.value = data.marketingBudget || 5000;

    const sellWoodVinegarCheckbox = document.getElementById('checkSellWoodVinegar');
    if (sellWoodVinegarCheckbox) sellWoodVinegarCheckbox.checked = data.sellWoodVinegar || false;

    const woodVinegarYieldSelect = document.getElementById('selectWoodVinegarYield');
    if (woodVinegarYieldSelect) woodVinegarYieldSelect.value = data.woodVinegarYield || 50;

    const woodVinegarPriceInput = document.getElementById('inputWoodVinegarPrice');
    if (woodVinegarPriceInput) woodVinegarPriceInput.value = data.woodVinegarPrice || 1.00;

    const woodVinegarPackagingInput = document.getElementById('inputWoodVinegarPackaging');
    if (woodVinegarPackagingInput) woodVinegarPackagingInput.value = data.woodVinegarPackaging || 0.30;

    const woodVinegarDistributionInput = document.getElementById('inputWoodVinegarDistribution');
    if (woodVinegarDistributionInput) woodVinegarDistributionInput.value = data.woodVinegarDistribution || 0.05;

    const notesInput = document.getElementById('toolNotes');
    if (notesInput) notesInput.value = data.notes_T4 || "";
}

            saveButton.classList.add('hidden');
            navigationButtons.classList.remove('hidden');
            unsavedWarning.classList.add('hidden');
        }
        handleBiocharModelChange();
        if(document.getElementById('checkSellWoodVinegar').checked){ setupCheckboxToggle('checkSellWoodVinegar','woodVinegarFields',true); }
    } catch(e){ console.error(e); showError("Error cargando datos del proyecto."); }
}

// --- SAVE PROJECT ---
function saveProject() {
    const creditPriceInput = document.getElementById('inputCreditPrice');
    if (!creditPriceInput) {
        alert("Error: Falta el campo de Precio de Crédito de Carbono.");
        return;
    }

    saveButton.textContent = "Guardando...";
    saveButton.disabled = true;
    if (saveStatus) saveStatus.style.display = 'none';

    try {
        projectData.tool4 = {
            carbonCreditPrice: parseFloat(creditPriceInput.value) || 0,
            salesModel: document.getElementById('selectBiocharModel')?.value || "",
            retailMixPercent: parseFloat(document.getElementById('inputBiocharPercentInMix')?.value) || 0,
            compostCost: parseFloat(document.getElementById('inputCompostCost')?.value) || 0,
            retailBagWeightKg: parseFloat(document.getElementById('inputBagWeightKg')?.value) || 0,
            retailPricePerBag: parseFloat(document.getElementById('inputRetailPricePerBag')?.value) || 0,
            retailPackagingCostPerBag: parseFloat(document.getElementById('inputPackagingCostPerBag')?.value) || 0,
            retailDistributionCostPerBag: parseFloat(document.getElementById('inputDistributionCostPerBag')?.value) || 0,
            bulkPrice: parseFloat(document.getElementById('inputBulkPrice')?.value) || 0,
            soilAmendmentInitialCost: parseFloat(document.getElementById('inputInitialComplianceCost')?.value) || 0,
            soilAmendmentAnnualCost: parseFloat(document.getElementById('inputAnnualComplianceCost')?.value) || 0,
            salesRate: parseFloat(document.getElementById('selectSalesRate')?.value) || 0.75,
            marketingPlan: document.getElementById('selectMarketingPlan')?.value || "",
            marketingBudget: parseFloat(document.getElementById('inputMarketingBudget')?.value) || 0,
            sellWoodVinegar: document.getElementById('checkSellWoodVinegar')?.checked || false,
            woodVinegarYield: parseFloat(document.getElementById('selectWoodVinegarYield')?.value) || 50,
            woodVinegarPrice: parseFloat(document.getElementById('inputWoodVinegarPrice')?.value) || 1.00,
            woodVinegarPackaging: parseFloat(document.getElementById('inputWoodVinegarPackaging')?.value) || 0.30,
            woodVinegarDistribution: parseFloat(document.getElementById('inputWoodVinegarDistribution')?.value) || 0.05,
            totalFeedstockForVinegar: totalFeedstockForVinegar || 0,
            notes_T4: document.getElementById('toolNotes')?.value || "",
            lastUpdated: new Date().toISOString()
        };

        if (projectData.tool3 && !projectData.tool3.routes) delete projectData.tool3;
        if (projectData.notes_T3) delete projectData.notes_T3;

        if (window.BiocharEngine && BiocharEngine.saveProjectData) {
            BiocharEngine.saveProjectData(projectData);
        } else {
            localStorage.setItem('biocharProjectData', JSON.stringify(projectData));
        }

        if (saveStatus) {
            saveStatus.textContent = "Datos Guardados!";
            saveStatus.style.display = 'block';
            saveStatus.classList.remove('text-red-600');
            saveStatus.classList.add('text-green-600');
        }
        hasUnsavedChanges = false;
        if (unsavedWarning) unsavedWarning.classList.add('hidden');
        if (saveButton) saveButton.classList.add('hidden');
        if (navigationButtons) navigationButtons.classList.remove('hidden');

    } catch (err) {
        console.error("Error al guardar:", err);
        showError("Error al guardar los datos. Inténtalo de nuevo.");
        saveButton.textContent = "Guardar Datos de Ingresos";
        saveButton.disabled = false;
    }
}

// --- UI FUNCTIONS ---
function setupCheckboxToggle(checkboxId, fieldsId, skipEvent=false){
    const checkbox = document.getElementById(checkboxId); const fields = document.getElementById(fieldsId);
    if(!checkbox||!fields) return;
    const toggle = ()=>{ if(checkbox.checked){ fields.style.maxHeight=fields.scrollHeight+'px'; fields.style.opacity='1'; } else { fields.style.maxHeight='0'; fields.style.opacity='0'; } };
    if(!skipEvent) checkbox.addEventListener('change',toggle); else toggle();
}
function handleBiocharModelChange(){
    const model=document.getElementById('selectBiocharModel').value;
    document.getElementById('retailFields').style.display=model==='retail'?'block':'none';
    document.getElementById('bulkFields').style.display=model==='bulk'?'block':'none';
}
function showError(msg){
    if(saveStatus){ saveStatus.textContent=msg; saveStatus.style.display='block'; saveStatus.className='font-medium text-red-600'; }
    if(loadingIndicatorCredits){ loadingIndicatorCredits.textContent=msg; loadingIndicatorCredits.classList.add('text-red-600'); }
    if(loadingIndicatorBiochar){ loadingIndicatorBiochar.textContent=msg; loadingIndicatorBiochar.classList.add('text-red-600'); }
}
window.navigate=function(url){ if(hasUnsavedChanges){ alert("Tienes cambios sin guardar. Por favor, guarda primero."); } else { window.location.href=url; } }
window.resetForm=function(){ if(!confirm("Esto borrará TODOS los datos del proyecto. ¿Estás seguro?")) return; projectData={}; if(window.BiocharEngine && BiocharEngine.clearProjectData){ BiocharEngine.clearProjectData(); } else{ localStorage.removeItem("biocharProjectData"); localStorage.removeItem("currentProjectId"); } location.reload(); }
</script>
</body>
</html>