<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Logística (Ferramenta 3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="engine.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f4f5; }
        
        /* Grouping Style */
        .input-section { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6; }
        .step-group { @apply bg-gray-50 border-gray-300; }

        /* Green Headers */
        .section-title { @apply text-2xl font-extrabold text-green-700 mb-4 pb-2 border-b border-gray-200; }
        
        .label-text { @apply block text-sm font-medium text-gray-700 mb-1; }
        .input-field { @apply mt-1 block w-full rounded-md border-gray-400 shadow-sm p-2 bg-white focus:border-green-500 focus:ring-green-500 transition duration-150 box-border; }
        .input-field[readonly] { @apply bg-gray-100 text-gray-500 cursor-not-allowed; }
        
        .route-card { @apply bg-white p-4 rounded-lg border border-gray-300 mb-4 relative shadow-sm; }
        .remove-route { @apply absolute top-2 right-2 text-red-500 hover:text-red-700 cursor-pointer text-xl font-bold; }
        .add-button { @apply w-full py-4 bg-green-600 border-2 border-transparent text-white font-bold text-lg rounded-xl hover:bg-green-700 transition duration-150 flex items-center justify-center shadow-md; }
        .summary-box { @apply p-4 rounded-lg text-white shadow-md; }
        
        /* --- TOOLTIPS & ICONS --- */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; cursor: help; vertical-align: middle; }
        .tooltip-icon { width: 16px; height: 16px; background-color: #9ca3af; color: white; font-size: 10px; font-weight: bold; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 6px; }
        
        /* Formula Icon (f) */
        .f-icon { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: #6b7280; color: white; border-radius: 50%; font-family: 'Georgia', serif; font-style: italic; font-weight: bold; font-size: 14px; line-height: 1; padding-bottom: 2px; margin-left: 6px; }
        .f-icon-light { background-color: #fff; color: #1e3a8a; margin-left: 6px; }

        .tooltip-text { position: absolute; width: 240px; background-color: #374151; color: white; font-size: 0.75rem; padding: 10px; border-radius: 6px; bottom: 150%; left: 50%; transform: translateX(-50%); visibility: hidden; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 50; font-weight: normal; text-align: left; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* --- PROGRESS BAR --- */
        .progress-bar-container { @apply w-full bg-gray-200 rounded-full h-2.5 mb-6; }
        .progress-bar { @apply bg-green-600 h-2.5 rounded-full transition-all duration-500; }
        
        /* --- FOOTER (NEW) --- */
        .disclaimer {
            text-align: left;
            font-size: 0.75rem;
            color: #6b7280; /* gray-500 */
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        .disclaimer p {
            margin-bottom: 0.5rem;
            font-style: italic;
        }
        .disclaimer strong {
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            font-style: normal;
        }

        /* --- NAVIGATION BUTTONS --- */
        .nav-grid { @apply grid grid-cols-2 md:grid-cols-3 gap-3 items-center; }
        .nav-button { display: inline-block; padding: 12px 20px; font-weight: 700; border: none; border-radius: 12px; font-size: 0.875rem; cursor: pointer; transition: opacity 0.2s; text-decoration: none; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .nav-button:hover { opacity: 0.9; }
        .nav-button-blue { background-color: #2563eb; color: white; }
        .nav-button-green { background-color: #16a34a; color: white; }
        .nav-button-indigo { background-color: #4f46e5; color: white; }
        .nav-button-white { background-color: white; color: #2563eb; border: 2px solid #dbeafe; }
        .nav-button-white:hover { background-color: #f9fafb; }
        
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-extrabold text-green-700">Calculadora de Viabilidade de Biochar</h1>
            <h2 class="text-lg font-medium text-gray-700 mt-1">para Cadeias de Suprimento de Café e Cacau na América Latina</h2>
            <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mt-4">Climatebase Fellowship Cohort 8 - Projeto Capstone</p>
            <p class="text-xs font-medium text-gray-500 mt-2">(Todos os valores em USD)</p>
            
            <div class="mt-4 mb-6">
                <a href="https://chatgpt.com/g/g-691ea2b1c2888191b85e54e203c53b2f-biochar-feasibility-guide" 
                   target="_blank" 
                   class="inline-block bg-blue-50 text-blue-700 hover:text-blue-900 border border-blue-200 rounded-full px-4 py-1 text-sm font-medium transition">
                    Perguntas? Clique aqui para consultar o Assistente de IA de Biochar ↗
                </a>
            </div>

            <p class="text-lg font-medium text-green-800">Ferramenta 3: Logística (Entrada)</p>
        </header>

        <div class="w-full mb-8">
            <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                <span>Passo 3 de 7: Logística</span>
                <span>(Próximo: Receita)</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 42.8%"></div> </div>
        </div>

        <div class="input-section step-group">
            <h2 class="section-title">Passo 1: Definir Meta Logística</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-white p-4 rounded-lg border border-gray-300">
                <label class="block">
                    <span class="label-text font-semibold text-gray-900">Matéria-Prima Total Necessária</span>
                    <input type="number" id="inputTotalFeedstock" value="0" class="input-field" readonly>
                    <p id="loadingIndicator" class="text-xs text-yellow-700 mt-1">Carregando da Ferramenta 2...</p>
                </label>
                <label class="block">
                    <span class="label-text font-semibold text-gray-900">(-) Entrega pelo Fornecedor (Custo $0)</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Matéria-prima que chega ao forno SEM custo logístico para você.</span></div>
                    <input type="number" id="inputSelfDelivered" value="0" min="0" class="input-field border-yellow-400" required>
                </label>
                <div class="flex flex-col justify-center p-3 bg-yellow-100 rounded-lg border-2 border-yellow-300 text-center">
                    <span class="label-text font-bold text-yellow-900 uppercase tracking-wider">Meta Logística</span>
                    <span id="logisticsTarget" class="text-3xl font-extrabold text-yellow-800">0 t</span>
                </div>
            </div>

            <div id="annualRainContainer" class="mb-4 hidden">
                <label class="block">
                    <span class="label-text">Duração da Estação Chuvosa (Meses/Ano)</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Usado para ponderar o custo anual entre tarifas de estação Seca e Chuvosa.</span></div>
                    <input type="range" id="inputRainyMonths" min="0" max="12" value="6" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer mt-2">
                    <div class="flex justify-between text-xs text-gray-500 px-1 mt-1">
                        <span>0m (Todo Seco)</span><span id="rainyMonthsVal" class="font-bold text-blue-600">6 meses</span><span>12m (Todo Chuva)</span>
                    </div>
                </label>
            </div>

            <div id="seasonalWindowContainer" class="hidden mt-4 p-4 bg-blue-100 rounded-lg border border-blue-300">
                <h4 class="font-bold text-blue-900 mb-3">Lógica de Coleta Sazonal</h4>
                <p class="text-sm text-blue-800 mb-3">Seu projeto é sazonal. Defina a janela específica para cada rota abaixo.</p>
            </div>
            
            <div id="mobileInfoBox" class="hidden mt-4 p-4 bg-blue-100 rounded-lg border border-blue-300">
                <p class="text-sm font-bold text-blue-900">Nota: Os custos de realocação do forno móvel estão na Ferramenta 5.</p>
            </div>
        </div>

        <div class="input-section step-group">
            <h2 class="section-title">Passo 2: Criar Rotas de Transporte</h2>
            <p class="text-sm text-gray-600 mb-4">Sua matéria-prima restante pode chegar via transporte regional. Aloque este volume às rotas abaixo.</p>

            <div id="routesContainer">
                </div>

            <button id="addRouteBtn" class="add-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Adicionar Rota
            </button>
        </div>
        
        <div class="input-section step-group">
            <h2 class="section-title">Passo 3: Resumo Logístico Final</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="summary-box bg-blue-800 text-white">
                    <h3 class="text-sm uppercase tracking-wider opacity-80 mb-1 text-blue-200">Status da Meta</h3>
                    <p id="outputStatus" class="text-2xl font-bold mt-2 leading-tight text-white">0t / 0t</p>
                    <p id="outputStatusSub" class="text-xs opacity-80">Volume Movido vs. Meta</p>
                </div>
                <div class="summary-box bg-green-700">
                    <h3 class="text-sm uppercase tracking-wider opacity-80 mb-1 text-green-100 flex items-center">
                        Custo Logístico Anual Total
                        <div class="tooltip-container">
                            <span class="f-icon f-icon-light">f</span>
                            <span class="tooltip-text">**Fórmula:**<br>Soma de custos das rotas.<br><br>Cada rota: (Viagens/Ano) × (Custo Médio Ponderado)</span>
                        </div>
                    </h3>
                    <p id="outputAnnualCost" class="text-3xl font-extrabold text-white">$0</p>
                </div>
                <div class="summary-box bg-blue-600">
                    <h3 class="text-sm uppercase tracking-wider opacity-80 mb-1 text-blue-100 flex items-center">
                        Custo por Tonelada
                        <div class="tooltip-container">
                            <span class="f-icon f-icon-light">f</span>
                            <span class="tooltip-text">**Fórmula:**<br> (Custo Total Logística) / (Total Matéria-Prima)</span>
                        </div>
                    </h3>
                    <p id="outputCostPerTonne" class="text-3xl font-extrabold text-white">$--</p>
                </div>
            </div>
        </div>

        <div class="input-section bg-gray-50 border-l-4 border-gray-400 p-4">
            <h3 class="font-bold text-gray-700 mb-2 uppercase text-sm tracking-wider">Notas para Pesquisa Futura</h3>
            <textarea id="toolNotes" rows="3" class="input-field bg-white" placeholder="Escreva aqui..."></textarea>
        </div>

        <div class="mt-8 mb-12 flex flex-col space-y-4">
            <button id="saveToDbButton" class="nav-button nav-button-indigo w-full">Salvar Dados Logísticos</button>
            <div id="unsavedWarning" class="text-red-600 font-medium text-center hidden">Você tem alterações não salvas.</div>

            <div id="navigationButtons" class="nav-grid hidden">
                <button onclick="navigate('tool2_pt.html')" class="nav-button nav-button-blue md:col-span-1">← Voltar para Ferramenta 2</button>
                <button onclick="navigate('index_pt.html')" class="nav-button nav-button-white md:col-span-1">Menu Principal</button>
                <button onclick="navigate('tool4_pt.html')" id="nextToolButton" class="nav-button nav-button-green md:col-span-1">Ir para Ferramenta 4 →</button>
            </div>
            <div class="flex justify-between items-center pt-4">
                <button onclick="resetForm()" class="text-sm text-red-500 hover:text-red-700 font-medium">
                    Reiniciar Formulário
                </button>
                <div id="saveStatus" class="font-medium text-green-600" style="display: none;"></div>
            </div>
        </div>
    </div>

    <template id="routeTemplate">
        <div class="route-card">
            <div class="remove-route" style="display: none;">×</div> <h3 class="font-bold text-gray-800 mb-3 route-title">Rota #1</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <label class="block"><span class="label-text">Nome da Rota</span><input type="text" class="input-field route-name" placeholder="ex. Rota Semanal Fazenda A"></label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="block"><span class="label-text">Volume Anual (t)</span><input type="number" class="input-field route-vol" value="0" min="0"></label>
                        <label class="block"><span class="label-text">Viagens por Ano</span><input type="number" class="input-field route-freq" value="52" min="1"></label>
                    </div>
                    
                    <p class="text-xs text-gray-500 italic">Carga Média: <span class="route-avg-load font-bold">0</span> t/viagem <span class="tooltip-container ml-1"><span class="f-icon">f</span><span class="tooltip-text">**Fórmula:** (Volume Anual) / (Viagens por Ano)</span></span> <span class="block mt-1 text-gray-400">Nota: Garanta que a frequência é realista. Um caminhão rural típico carrega 4-5 toneladas.</span></p>
                    
                    <div class="seasonal-route-inputs hidden mt-3 p-3 bg-blue-50 rounded border border-blue-200">
                        <h4 class="text-xs font-bold text-blue-800 mb-2 uppercase tracking-wider">Janela Sazonal</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="block"><span class="label-text text-xs">Duração (Semanas)</span><input type="number" class="input-field route-weeks" value="10" min="1"></label>
                            <label class="block"><span class="label-text text-xs">Semanas Chuvosas</span><input type="number" class="input-field route-rainy-weeks" value="0" min="0"></label>
                        </div>
                    </div>
                </div>

                <div class="space-y-3 bg-gray-100 p-4 rounded-lg border-2 border-gray-300">
                    <label class="block">
                        <span class="label-text font-bold text-gray-800">Modelo de Propriedade do Caminhão</span>
                        <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Selecione 'Próprio' se pagar ao motorista por hora. Selecione 'Terceirizado' se pagar uma tarifa fixa por viagem.</span></div>
                        <select class="input-field route-method font-medium text-gray-900">
                            <option value="" disabled selected>-- Selecionar Modelo --</option>
                            <option value="time">Caminhão Próprio (Cálculo por Tempo)</option>
                            <option value="flat">Frete Terceirizado (Tarifa Fixa)</option>
                        </select>
                    </label>
                    
                    <div class="time-inputs hidden space-y-5 mt-4">
                        <label class="block">
                            <span class="label-text font-semibold">Custo Total por Hora ($/hr)</span>
                            <div class="tooltip-container ml-1"><span class="tooltip-icon">?</span><span class="tooltip-text">Inclua despesas operacionais como combustível, manutenção, reparos, seguro e registro. Não inclua salários do motorista (vão na Ferramenta 5) nem o custo de compra do veículo (também na Ferramenta 5). Se não tiver certeza, pergunte à IA: "Ajude-me a estimar o custo operacional do meu caminhão".</span></div>
                            <input type="number" class="input-field route-rate border-2 border-gray-300" value="55" min="0">
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-orange-100 rounded-lg border-2 border-orange-300 p-3"><label class="block"><span class="label-text text-orange-900 font-bold mb-2 block leading-tight">Horas Ida/Volta (Seca)</span><input type="number" class="input-field route-hours-dry border-orange-300" value="4" min="0.5" step="0.5"></label></div>
                            <div class="bg-blue-100 rounded-lg border-2 border-blue-300 p-3"><label class="block"><span class="label-text text-blue-900 font-bold mb-2 block leading-tight">Horas Ida/Volta (Chuva)</span><input type="number" class="input-field route-hours-rain border-blue-300" value="6" min="0.5" step="0.5"></label></div>
                        </div>
                    </div>

                    <div class="flat-inputs hidden space-y-5 mt-4">
                        <p class="text-xs text-gray-500 mb-2">
                            <span class="font-bold">Nota:</span> Use o preço total negociado com o motorista para ida e volta.
                        </p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-orange-100 rounded-lg border-2 border-orange-300 p-3"><label class="block"><span class="label-text text-orange-900 font-bold mb-2 block">Cotação Seca ($)</span><input type="number" class="input-field route-quote-dry border-orange-300" value="150" min="0"></label></div>
                            <div class="bg-blue-100 rounded-lg border-2 border-blue-300 p-3"><label class="block"><span class="label-text text-blue-900 font-bold mb-2 block">Cotação Chuva ($)</span><input type="number" class="input-field route-quote-rain border-blue-300" value="175" min="0"></label></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-right text-sm font-bold text-green-700">
                Est. Custo Anual: <span class="route-annual-cost">$0</span>
                <span class="tooltip-container ml-1"><span class="f-icon">f</span><span class="tooltip-text">**Fórmula:** (Viagens) × (Custo Médio Ponderado)</span></span>
            </div>
        </div>
    </template>

    <footer class="disclaimer">
        <p><strong>Sem Garantia:</strong> <em>As projeções fornecidas por esta calculadora baseiam-se nas suposições e dados inseridos pelo usuário. São apenas para fins ilustrativos e não constituem uma garantia de custos reais, receitas ou lucratividade.</em></p>
        <p><strong>Não é Consultoria Financeira:</strong> <em>As informações fornecidas não pretendem substituir a consultoria profissional financeira, jurídica ou agrícola. Os usuários são os únicos responsáveis pelas decisões tomadas com base nos resultados desta ferramenta.</em></p>
        <p><strong>Verificar Todos os Dados:</strong> <em>Os usuários devem verificar independentemente todos os custos locais, preços de mercado e requisitos regulatórios antes de realizar qualquer investimento.</em></p>
    </footer>
<script>
        // --- GLOBAL STATE ---
        let projectData = {};
        let T1_Data = {}; 
        let routeCount = 0;
        let hasUnsavedChanges = false;

        function createRouteCard() {
            routeCount++; 

            const card = document.createElement('div');
            card.className = 'route-card p-4 mb-4 bg-white rounded-lg border border-gray-200';

            const routeName = document.createElement('input');
            routeName.type = 'text';
            routeName.className = 'route-name input-field';
            routeName.value = `Rota ${routeCount}`; 

            const routeVol = document.createElement('input');
            routeVol.type = 'number';
            routeVol.className = 'route-vol input-field';
            routeVol.value = 0;

            const routeFreq = document.createElement('input');
            routeFreq.type = 'number';
            routeFreq.className = 'route-freq input-field';
            routeFreq.value = 0;

            const routeMethod = document.createElement('select');
            routeMethod.className = 'route-method input-field';
            routeMethod.innerHTML = `<option value="owned">Caminhão Próprio</option><option value="hired">Frete Terceirizado</option>`;

            card.appendChild(routeName);
            card.appendChild(routeVol);
            card.appendChild(routeFreq);
            card.appendChild(routeMethod);

            return card;
        }

        // --- Static DOM references ---
        const saveButton = document.getElementById('saveToDbButton');
        const navigationButtons = document.getElementById('navigationButtons');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const saveStatus = document.getElementById('saveStatus');
        const unsavedWarning = document.getElementById('unsavedWarning');
        
        const seasonalContainer = document.getElementById('seasonalWindowContainer');
        const annualContainer = document.getElementById('annualRainContainer');
        const mobileInfoBox = document.getElementById('mobileInfoBox');

        const inputsToTrack = [
            'inputSelfDelivered', 'inputRainyMonths', 'toolNotes'
        ];

        window.addEventListener("beforeunload", e => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = "";
            }
        });

        function setUnsaved() {
            hasUnsavedChanges = true;
            if (saveButton) {
                saveButton.classList.remove("hidden");
                saveButton.disabled = false;
            }
            if (navigationButtons) navigationButtons.classList.add("hidden");
            if (unsavedWarning) unsavedWarning.classList.remove("hidden");
            if (saveStatus) saveStatus.style.display = 'none';
        }
        
        function addUnsavedListeners(elements) {
            elements.forEach(el => {
                const eventType = (el.tagName === 'SELECT' || el.type === 'checkbox') ? 'change' : 'input';
                el.addEventListener(eventType, setUnsaved);
            });
        }

       document.addEventListener('DOMContentLoaded', () => {
            if (window.BiocharEngine && BiocharEngine.loadProjectData) {
                projectData = BiocharEngine.loadProjectData() || {};
            } else {
                const stored = localStorage.getItem("biocharProjectData");
                projectData = stored ? JSON.parse(stored) : {};
            }
            const t3 = projectData.tool3 || {}; 

            const t1 = projectData.tool1 || {};
            T1_Data = {
                supplyModel: t1.supplyModel || "year_round",
                projectType: t1.projectType || "centralized"
            };

            if (Object.keys(projectData).length > 0 && !projectData.tool1) {
                console.warn("Tool 1 missing for this project");
                showError("Faltam dados da Ferramenta 1. Por favor complete a Ferramenta 1 primeiro.");
            }

            let totalFeedstock = 0;
            if (projectData.tool2 && projectData.tool2.diversified) {
                const d = projectData.tool2.diversified;
                totalFeedstock = (d.f1_tonnes || 0) + (d.f2_tonnes || 0);
                if (loadingIndicator) {
                    loadingIndicator.textContent = "Carregado da Ferramenta 2";
                    loadingIndicator.classList.remove('text-yellow-700', 'text-red-600');
                    loadingIndicator.classList.add('text-green-600');
                }
            } else {
                if (loadingIndicator) {
                    loadingIndicator.textContent = "Faltam dados da Ferramenta 2";
                    loadingIndicator.classList.remove('text-yellow-700', 'text-green-600');
                    loadingIndicator.classList.add('text-red-600');
                }
            }
            document.getElementById('inputTotalFeedstock').value = totalFeedstock;

            const isSeasonal = T1_Data.supplyModel === 'seasonal';
            const isMobile = T1_Data.projectType === 'mobile';
            toggleSeasonalWindow(isSeasonal, isMobile);

            const selfDeliveredInput = document.getElementById('inputSelfDelivered');
            const rainyMonthsInput = document.getElementById('inputRainyMonths');
            const rainyMonthsVal = document.getElementById('rainyMonthsVal');
            const notesArea = document.getElementById('toolNotes');
            const routesContainer = document.getElementById('routesContainer');

            routeCount = 0; 
            if (routesContainer) {
                routesContainer.innerHTML = ''; 
            }

            if (t3 && t3.lastUpdated) {
                if (selfDeliveredInput) selfDeliveredInput.value = t3.selfDelivered || 0;
                if (rainyMonthsInput) {
                    rainyMonthsInput.value = t3.rainySeasonMonths || 6;
                    if (rainyMonthsVal) {
                        rainyMonthsVal.textContent = `${rainyMonthsInput.value} meses`;
                    }
                }
                if (notesArea && t3.notes_T3) {
                    notesArea.value = t3.notes_T3;
                }
            } else {
                if (selfDeliveredInput && selfDeliveredInput.value === "") {
                    selfDeliveredInput.value = 0;
                }
                if (rainyMonthsInput && rainyMonthsInput.value === "") {
                    rainyMonthsInput.value = 6;
                    if (rainyMonthsVal) {
                        rainyMonthsVal.textContent = "6 meses";
                    }
                }
            }

            if (Array.isArray(t3.routes) && t3.routes.length > 0) {
                t3.routes.forEach((r) => {
                    addRoute(r);
                });
            } else {
                addRoute(); 
            }

            if (t3 && t3.lastUpdated) {
                hasUnsavedChanges = false;
                if (saveButton) {
                    saveButton.classList.add('hidden');
                    saveButton.disabled = false;
                }
                if (navigationButtons) navigationButtons.classList.remove('hidden');
                if (unsavedWarning) unsavedWarning.classList.add('hidden');

                if (loadingIndicator) {
                    loadingIndicator.textContent = "Carregado da Ferramenta 3";
                    loadingIndicator.classList.remove('text-red-600', 'text-yellow-700');
                    loadingIndicator.classList.add('text-green-600');
                }
            } else {
                hasUnsavedChanges = false;
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.classList.remove('hidden');
                }
                if (navigationButtons) navigationButtons.classList.add('hidden');
                if (unsavedWarning) unsavedWarning.classList.add('hidden');
            }

            calculateAll();

            const addRouteBtn = document.getElementById('addRouteBtn');
            if (addRouteBtn) {
                addRouteBtn.addEventListener('click', () => {
                    addRoute();
                    setUnsaved();
                });
            }

            if (rainyMonthsInput) {
                rainyMonthsInput.addEventListener('input', (e) => {
                    if (rainyMonthsVal) {
                        rainyMonthsVal.textContent = `${e.target.value} meses`;
                    }
                    calculateAll();
                });
            }
            
            if (selfDeliveredInput) {
                selfDeliveredInput.addEventListener('input', calculateAll);
            }

            if (saveButton) {
                saveButton.addEventListener('click', saveProject);
            }

            addUnsavedListeners(inputsToTrack.map(id => document.getElementById(id)).filter(Boolean));
        }); 

        function toggleSeasonalWindow(isSeasonal, isMobile) {
            if (isSeasonal) {
                seasonalContainer.classList.remove('hidden');
                annualContainer.classList.add('hidden'); 
            } else {
                seasonalContainer.classList.add('hidden');
                annualContainer.classList.remove('hidden'); 
            }
            
            if (isMobile) {
                mobileInfoBox.classList.remove('hidden');
            } else {
                mobileInfoBox.classList.add('hidden');
            }

            document.querySelectorAll('.seasonal-route-inputs').forEach(div => {
                if (isSeasonal) div.classList.remove('hidden');
                else div.classList.add('hidden');
            });
 
            calculateAll(); 
        }

        function saveProject() {
            saveButton.textContent = "Salvando...";
            saveButton.disabled = true;
            saveStatus.style.display = 'none';
            
            const selfDelivered = document.getElementById('inputSelfDelivered').value;
            if (selfDelivered === "") {
                 alert("Por favor, insira um valor para 'Entrega pelo Fornecedor'. Você pode inserir 0.");
                 saveButton.textContent = "Salvar Dados Logísticos";
                 saveButton.disabled = false;
                 return;
            }

            let maxWindow = 0;
            const routes = [];
            document.querySelectorAll('.route-card').forEach(card => {
                const dur = parseFloat(card.querySelector('.route-weeks').value) || 0;
                if (dur > maxWindow) maxWindow = dur;

                routes.push({
                    name: card.querySelector('.route-name').value,
                    annualVolume: parseFloat(card.querySelector('.route-vol').value) || 0,
                    tripsPerYear: parseFloat(card.querySelector('.route-freq').value) || 0,
                    method: card.querySelector('.route-method').value,
                    hourlyRate: parseFloat(card.querySelector('.route-rate').value) || 0,
                    dryHours: parseFloat(card.querySelector('.route-hours-dry').value) || 0,
                    rainyHours: parseFloat(card.querySelector('.route-hours-rain').value) || 0,
                    dryQuote: parseFloat(card.querySelector('.route-quote-dry').value) || 0,
                    rainyQuote: parseFloat(card.querySelector('.route-quote-rain').value) || 0,
                    routeDuration: dur,
                    routeRainyWeeks: parseFloat(card.querySelector('.route-rainy-weeks').value) || 0,
                    annualCost: parseFloat(card.querySelector('.route-annual-cost').textContent.replace(/[^0-9.]/g, '')) || 0
                });
            });

            const isSeasonal = (T1_Data.supplyModel === 'seasonal');
            const masterWindow = (isSeasonal && maxWindow > 0) ? maxWindow : 52; 

            projectData.tool3 = {
                selfDelivered: parseFloat(selfDelivered) || 0,
                rainySeasonMonths: parseFloat(document.getElementById('inputRainyMonths').value) || 0,
                collectionWeeks: masterWindow, 
                routes: routes,
                totalAnnualLogisticsCost: parseFloat(document.getElementById('outputAnnualCost').textContent.replace(/[^0-9.]/g, '')) || 0,
                avgLogisticsCostPerTonne: parseFloat(document.getElementById('outputCostPerTonne').textContent.replace(/[^0-9.]/g, '')) || 0,
                notes_T3: document.getElementById('toolNotes').value,
                lastUpdated: new Date().toISOString()
            };
            
            if (projectData.tool4) {
                if (!projectData.tool4.salesModel) {
                    delete projectData.tool4;
                }
            }

            try {
                if (window.BiocharEngine) {
                    BiocharEngine.saveProjectData({
                        ...(projectData || {}),
                        tool3: projectData.tool3
                    });
                } else {
                    const existing = JSON.parse(localStorage.getItem("biocharProjectData") || "{}");
                    const merged = {
                        ...existing,
                        tool3: projectData.tool3
                    };
                    localStorage.setItem("biocharProjectData", JSON.stringify(merged));
                }

                saveStatus.textContent = "Dados Salvos!";
                saveStatus.style.display = 'block';

                hasUnsavedChanges = false;
                unsavedWarning.classList.add('hidden');
                saveButton.classList.add('hidden');
                navigationButtons.classList.remove('hidden');

            } catch (error) {
                showError("Falha ao salvar.");
                saveButton.textContent = "Salvar Dados Logísticos";
                saveButton.disabled = false;
            }
        }

        function calculateRouteCost(card, isSeasonal) {
            const trips = parseFloat(card.querySelector('.route-freq').value) || 0;
            const method = card.querySelector('.route-method').value;

            let rainyRatio = 0;
            if (isSeasonal) {
                const dur = parseFloat(card.querySelector('.route-weeks').value) || 10;
                const rain = parseFloat(card.querySelector('.route-rainy-weeks').value) || 0;
                if (dur > 0) rainyRatio = Math.min(1, rain / dur);
            } else {
                const rainMonths = parseFloat(document.getElementById('inputRainyMonths').value) || 0;
                rainyRatio = rainMonths / 12;
            }
            const dryRatio = 1 - rainyRatio;

            let avgCostPerTrip = 0;
            if (method === 'time') {
                const rate = parseFloat(card.querySelector('.route-rate').value) || 0;
                const dryHrs = parseFloat(card.querySelector('.route-hours-dry').value) || 0;
                const rainHrs = parseFloat(card.querySelector('.route-hours-rain').value) || 0;
                avgCostPerTrip = (dryHrs * rate * dryRatio) + (rainHrs * rate * rainyRatio);
            } else if (method === 'flat') {
                const dryQuote = parseFloat(card.querySelector('.route-quote-dry').value) || 0;
                const rainQuote = parseFloat(card.querySelector('.route-quote-rain').value) || 0;
                avgCostPerTrip = (dryQuote * dryRatio) + (rainQuote * rainyRatio);
            }

            const annualCost = trips * avgCostPerTrip;
            card.querySelector('.route-annual-cost').textContent = formatCurrency(annualCost);
            return annualCost;
        }

        function calculateAll() {
            const isSeasonal = T1_Data.supplyModel === 'seasonal';
            
            const totalProjectFeedstockDisplay = parseFloat(document.getElementById('inputTotalFeedstock').value) || 0;
            const selfDelivered = parseFloat(document.getElementById('inputSelfDelivered').value); 
            const logisticsTarget = Math.max(0, totalProjectFeedstockDisplay - (isNaN(selfDelivered) ? 0 : selfDelivered));
            document.getElementById('logisticsTarget').textContent = `${logisticsTarget.toLocaleString()} t`;

            let totalAnnualCost = 0, totalVolume = 0;
            document.querySelectorAll('.route-card').forEach(card => {
                const vol = parseFloat(card.querySelector('.route-vol').value) || 0;
                const trips = parseFloat(card.querySelector('.route-freq').value) || 1;
                totalVolume += vol;
                card.querySelector('.route-avg-load').textContent = (vol / trips).toFixed(1);
                totalAnnualCost += calculateRouteCost(card, isSeasonal);
            });

            document.getElementById('outputAnnualCost').textContent = formatCurrency(totalAnnualCost);
            document.getElementById('outputCostPerTonne').textContent =
                totalProjectFeedstockDisplay > 0
                    ? formatCurrency(totalAnnualCost / totalProjectFeedstockDisplay, true)
                    : '$--';

            const statusEl = document.getElementById('outputStatus');
            const statusSub = document.getElementById('outputStatusSub');
            statusEl.textContent = `${totalVolume.toLocaleString()}t / ${logisticsTarget.toLocaleString()}t`;
            statusEl.classList.remove('text-yellow-300','text-red-300','text-green-300','text-white');

            const ratio = logisticsTarget > 0 ? totalVolume / logisticsTarget : (totalVolume > 0 ? 999 : 1);
            if (ratio < 0.95) {
                statusEl.classList.add('text-yellow-300');
                statusSub.textContent = "Meta não atingida";
            } else if (ratio > 1.05) {
                statusEl.classList.add('text-red-300');
                statusSub.textContent = "Excesso de capacidade";
            } else {
                statusEl.classList.add('text-green-300');
                statusSub.textContent = "Meta atingida";
            }
        }

        function addRoute(data = null) {
            routeCount++;
            const template = document.getElementById('routeTemplate');
            if (!template) return;
            
            const clone = template.content.cloneNode(true);
            clone.querySelector('.route-title').textContent = `Rota #${routeCount}`;
            
            const isSeasonal = (T1_Data.supplyModel === 'seasonal');
            const seasonalInputs = clone.querySelector('.seasonal-route-inputs');
            if (isSeasonal) seasonalInputs.classList.remove('hidden');
            else seasonalInputs.classList.add('hidden');

            if (data) {
                clone.querySelector('.route-name').value = data.name || '';
                clone.querySelector('.route-vol').value = data.annualVolume || 0; 
                clone.querySelector('.route-freq').value = data.tripsPerYear || 52;
                clone.querySelector('.route-method').value = data.method || '';
                clone.querySelector('.route-rate').value = data.hourlyRate || 55;
                clone.querySelector('.route-hours-dry').value = data.dryHours || 4;
                clone.querySelector('.route-hours-rain').value = data.rainyHours || 6;
                clone.querySelector('.route-quote-dry').value = data.dryQuote || 150;
                clone.querySelector('.route-quote-rain').value = data.rainyQuote || 175;
                if (data.routeDuration) clone.querySelector('.route-weeks').value = data.routeDuration;
                if (data.routeRainyWeeks !== undefined) clone.querySelector('.route-rainy-weeks').value = data.routeRainyWeeks;
                
                const methodSelect = clone.querySelector('.route-method');
                toggleMethod(methodSelect, false); 
            }

            const dynamicInputs = clone.querySelectorAll('input, select');
            dynamicInputs.forEach(el => {
                const eventType = (el.tagName === 'SELECT' || el.type === 'checkbox') ? 'change' : 'input';
                el.addEventListener(eventType, calculateAll);
                el.addEventListener(eventType, setUnsaved);
            });
            
            clone.querySelector('.remove-route').addEventListener('click', function() {
                removeRoute(this.closest('.route-card'));
                setUnsaved(); 
            });
            clone.querySelector('.route-method').addEventListener('change', function() {
                toggleMethod(this, true); 
            });

            document.getElementById('routesContainer').appendChild(clone);
            updateRemoveButtons(); 
            if (!data) {
                calculateAll(); 
            }
            return clone;
        }

        function updateRemoveButtons() {
            const routes = document.querySelectorAll('.route-card');
            const showRemove = routes.length > 1;
            routes.forEach(route => {
                const removeBtn = route.querySelector('.remove-route');
                if (removeBtn) {
                    removeBtn.style.display = showRemove ? 'block' : 'none';
                }
            });
        }

        function removeRoute(el) {
            el.closest('.route-card').remove();
            calculateAll();
            updateRemoveButtons(); 
        }

        function toggleMethod(selectEl, doCalculate = true) {
            const card = selectEl.closest('.route-card');
            const timeInputs = card.querySelector('.time-inputs');
            const flatInputs = card.querySelector('.flat-inputs');
            
            timeInputs.classList.add('hidden');
            flatInputs.classList.add('hidden');

            if (selectEl.value === 'time') {
                timeInputs.classList.remove('hidden');
            } else if (selectEl.value === 'flat') {
                flatInputs.classList.remove('hidden');
            }
            
            if (doCalculate) {
                calculateAll();
            }
        }
        
        function formatCurrency(num, twoDecimals = false) {
            const options = { style: 'currency', currency: 'USD', maximumFractionDigits: twoDecimals ? 2 : 0 };
            return new Intl.NumberFormat('en-US', options).format(num);
        }

        function showError(msg) {
            if (saveStatus) {
                saveStatus.textContent = msg;
                saveStatus.style.display = 'block';
                saveStatus.className = 'font-medium text-red-600'; 
            }
            if (loadingIndicator) {
                loadingIndicator.textContent = msg;
                loadingIndicator.classList.remove('text-yellow-700');
                loadingIndicator.classList.add('text-red-600');
            }
        }

        // *** NEW: Smart Navigation ***
        window.navigate = function(url) {
            if (hasUnsavedChanges) {
                alert("Você tem alterações não salvas. Clique em 'Salvar' antes de continuar.");
            } else {
                window.location.href = url;
            }
        }

        // *** NEW: Global Reset Button Logic ***
        window.resetForm = function() {
            if (!confirm("Isso apagará TODOS os dados do projeto. Tem certeza?")) return;

            // Clear everything
            projectData = {}; 

            if (window.BiocharEngine && BiocharEngine.clearProjectData) {
                BiocharEngine.clearProjectData();
            } else {
                // Fallback for older engine.js
                localStorage.removeItem("biocharProjectData");
                localStorage.removeItem("currentProjectId");
            }

            // Force reload to empty form
            location.reload();
        }

    </script>
</body>
</html>